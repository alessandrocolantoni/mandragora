/* ====================================================================
 *		      GNU GENERAL PUBLIC LICENSE
 *		         Version 2, June 1991
 *
 *    Copyright (C) 1989, 1991 Free Software Foundation, Inc.
 *                        51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *    Everyone is permitted to copy and distribute verbatim copies
 *  of this license document, but changing it is not allowed.
 *
 *  			    Preamble
 *
 *    The licenses for most software are designed to take away your
 *  freedom to share and change it.  By contrast, the GNU General Public
 *  License is intended to guarantee your freedom to share and change free
 *  software--to make sure the software is free for all its users.  This
 *  General Public License applies to most of the Free Software
 *  Foundation's software and to any other program whose authors commit to
 *  using it.  (Some other Free Software Foundation software is covered by
 *  the GNU Library General Public License instead.)  You can apply it to
 *  your programs, too.
 *
 *    When we speak of free software, we are referring to freedom, not
 *  price.  Our General Public Licenses are designed to make sure that you
 *  have the freedom to distribute copies of free software (and charge for
 *  this service if you wish), that you receive source code or can get it
 *  if you want it, that you can change the software or use pieces of it
 *  in new free programs; and that you know you can do these things.
 *
 *     To protect your rights, we need to make restrictions that forbid
 *  anyone to deny you these rights or to ask you to surrender the rights.
 *  These restrictions translate to certain responsibilities for you if you
 *  distribute copies of the software, or if you modify it.
 *
 *     For example, if you distribute copies of such a program, whether
 *  gratis or for a fee, you must give the recipients all the rights that
 *  you have.  You must make sure that they, too, receive or can get the
 *  source code.  And you must show them these terms so they know their
 *  rights.
 *
 *     We protect your rights with two steps: (1) copyright the software, and
 *  (2) offer you this license which gives you legal permission to copy,
 *  distribute and/or modify the software.
 *
 *     Also, for each author's protection and ours, we want to make certain
 *  that everyone understands that there is no warranty for this free
 *  software.  If the software is modified by someone else and passed on, we
 *  want its recipients to know that what they have is not the original, so
 *  that any problems introduced by others will not reflect on the original
 *  authors' reputations.
 *
 *     Finally, any free program is threatened constantly by software
 *  patents.  We wish to avoid the danger that redistributors of a free
 *  program will individually obtain patent licenses, in effect making the
 *  program proprietary.  To prevent this, we have made it clear that any
 *  patent must be licensed for everyone's free use or not licensed at all.
 *
 *     The precise terms and conditions for copying, distribution and
 *  modification follow.
 *  
 *	                	    GNU GENERAL PUBLIC LICENSE
 *       TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
 *
 *     0. This License applies to any program or other work which contains
 *  a notice placed by the copyright holder saying it may be distributed
 *  under the terms of this General Public License.  The "Program", below,
 *  refers to any such program or work, and a "work based on the Program"
 *  means either the Program or any derivative work under copyright law:
 *  that is to say, a work containing the Program or a portion of it,
 *  either verbatim or with modifications and/or translated into another
 *  language.  (Hereinafter, translation is included without limitation in
 *  the term "modification".)  Each licensee is addressed as "you".
 *
 *     Activities other than copying, distribution and modification are not
 *  covered by this License; they are outside its scope.  The act of
 *  running the Program is not restricted, and the output from the Program
 *  is covered only if its contents constitute a work based on the
 *  Program (independent of having been made by running the Program).
 *  Whether that is true depends on what the Program does.
 *
 *     1. You may copy and distribute verbatim copies of the Program's
 *  source code as you receive it, in any medium, provided that you
 *  conspicuously and appropriately publish on each copy an appropriate
 *  copyright notice and disclaimer of warranty; keep intact all the
 *  notices that refer to this License and to the absence of any warranty;
 *  and give any other recipients of the Program a copy of this License
 *  along with the Program.
 *
 *  You may charge a fee for the physical act of transferring a copy, and
 *  you may at your option offer warranty protection in exchange for a fee.
 *
 *     2. You may modify your copy or copies of the Program or any portion
 *  of it, thus forming a work based on the Program, and copy and
 *  distribute such modifications or work under the terms of Section 1
 *  above, provided that you also meet all of these conditions:
 *
 *        a) You must cause the modified files to carry prominent notices
 *     stating that you changed the files and the date of any change.
 *
 *        b) You must cause any work that you distribute or publish, that in
 *     whole or in part contains or is derived from the Program or any
 *     part thereof, to be licensed as a whole at no charge to all third
 *     parties under the terms of this License.
 *
 *        c) If the modified program normally reads commands interactively
 *     when run, you must cause it, when started running for such
 *     interactive use in the most ordinary way, to print or display an
 *     announcement including an appropriate copyright notice and a
 *     notice that there is no warranty (or else, saying that you provide
 *     a warranty) and that users may redistribute the program under
 *     these conditions, and telling the user how to view a copy of this
 *     License.  (Exception: if the Program itself is interactive but
 *     does not normally print such an announcement, your work based on
 *     the Program is not required to print an announcement.)
 *     
 *     These requirements apply to the modified work as a whole.  If
 *  identifiable sections of that work are not derived from the Program,
 *  and can be reasonably considered independent and separate works in
 *  themselves, then this License, and its terms, do not apply to those
 *  sections when you distribute them as separate works.  But when you
 *  distribute the same sections as part of a whole which is a work based
 *  on the Program, the distribution of the whole must be on the terms of
 *  this License, whose permissions for other licensees extend to the
 *  entire whole, and thus to each and every part regardless of who wrote it.
 *
 *     Thus, it is not the intent of this section to claim rights or contest
 *  your rights to work written entirely by you; rather, the intent is to
 *  exercise the right to control the distribution of derivative or
 *  collective works based on the Program.
 *
 *     In addition, mere aggregation of another work not based on the Program
 *  with the Program (or with a work based on the Program) on a volume of
 *  a storage or distribution medium does not bring the other work under
 *  the scope of this License.
 *
 *      3. You may copy and distribute the Program (or a work based on it,
 *  under Section 2) in object code or executable form under the terms of
 *  Sections 1 and 2 above provided that you also do one of the following:
 *
 *        a) Accompany it with the complete corresponding machine-readable
 *     source code, which must be distributed under the terms of Sections
 *     1 and 2 above on a medium customarily used for software interchange; or,
 *
 *        b) Accompany it with a written offer, valid for at least three
 *     years, to give any third party, for a charge no more than your
 *     cost of physically performing source distribution, a complete
 *     machine-readable copy of the corresponding source code, to be
 *     distributed under the terms of Sections 1 and 2 above on a medium
 *     customarily used for software interchange; or,
 *
 *        c) Accompany it with the information you received as to the offer
 *     to distribute corresponding source code.  (This alternative is
 *     allowed only for noncommercial distribution and only if you
 *     received the program in object code or executable form with such
 *     an offer, in accord with Subsection b above.)
 *
 *  The source code for a work means the preferred form of the work for
 *  making modifications to it.  For an executable work, complete source
 *  code means all the source code for all modules it contains, plus any
 *  associated interface definition files, plus the scripts used to
 *  control compilation and installation of the executable.  However, as a
 *  special exception, the source code distributed need not include
 *  anything that is normally distributed (in either source or binary
 *  form) with the major components (compiler, kernel, and so on) of the
 *  operating system on which the executable runs, unless that component
 *  itself accompanies the executable.
 *
 *  If distribution of executable or object code is made by offering
 *  access to copy from a designated place, then offering equivalent
 *  access to copy the source code from the same place counts as
 *  distribution of the source code, even though third parties are not
 *  compelled to copy the source along with the object code.
 *  
 *     4. You may not copy, modify, sublicense, or distribute the Program
 *  except as expressly provided under this License.  Any attempt
 *  otherwise to copy, modify, sublicense or distribute the Program is
 *  void, and will automatically terminate your rights under this License.
 *  However, parties who have received copies, or rights, from you under
 *  this License will not have their licenses terminated so long as such
 *  parties remain in full compliance.
 *
 *    5. You are not required to accept this License, since you have not
 *  signed it.  However, nothing else grants you permission to modify or
 *  distribute the Program or its derivative works.  These actions are
 *  prohibited by law if you do not accept this License.  Therefore, by
 *  modifying or distributing the Program (or any work based on the
 *  Program), you indicate your acceptance of this License to do so, and
 *  all its terms and conditions for copying, distributing or modifying
 *  the Program or works based on it.
 *
 *    6. Each time you redistribute the Program (or any work based on the
 *  Program), the recipient automatically receives a license from the
 *  original licensor to copy, distribute or modify the Program subject to
 *  these terms and conditions.  You may not impose any further
 *  restrictions on the recipients' exercise of the rights granted herein.
 *  You are not responsible for enforcing compliance by third parties to
 *  this License.
 *
 *    7. If, as a consequence of a court judgment or allegation of patent
 *  infringement or for any other reason (not limited to patent issues),
 *  conditions are imposed on you (whether by court order, agreement or
 *  otherwise) that contradict the conditions of this License, they do not
 *  excuse you from the conditions of this License.  If you cannot
 *  distribute so as to satisfy simultaneously your obligations under this
 *  License and any other pertinent obligations, then as a consequence you
 *  may not distribute the Program at all.  For example, if a patent
 *  license would not permit royalty-free redistribution of the Program by
 *  all those who receive copies directly or indirectly through you, then
 *  the only way you could satisfy both it and this License would be to
 *  refrain entirely from distribution of the Program.

 *  If any portion of this section is held invalid or unenforceable under
 *  any particular circumstance, the balance of the section is intended to
 *  apply and the section as a whole is intended to apply in other
 *  circumstances.

 *  It is not the purpose of this section to induce you to infringe any
 *  patents or other property right claims or to contest validity of any
 *  such claims; this section has the sole purpose of protecting the
 *  integrity of the free software distribution system, which is
 *  implemented by public license practices.  Many people have made
 *  generous contributions to the wide range of software distributed
 *  through that system in reliance on consistent application of that
 *  system; it is up to the author/donor to decide if he or she is willing
 *  to distribute software through any other system and a licensee cannot
 *  impose that choice.

 *  This section is intended to make thoroughly clear what is believed to
 *  be a consequence of the rest of this License.
 *  
 *    8. If the distribution and/or use of the Program is restricted in
 *  certain countries either by patents or by copyrighted interfaces, the
 *  original copyright holder who places the Program under this License
 *  may add an explicit geographical distribution limitation excluding
 *  those countries, so that distribution is permitted only in or among
 *  countries not thus excluded.  In such case, this License incorporates
 *  the limitation as if written in the body of this License.
 *
 *    9. The Free Software Foundation may publish revised and/or new versions
 *  of the General Public License from time to time.  Such new versions will
 *  be similar in spirit to the present version, but may differ in detail to
 *  address new problems or concerns.
 *
 *  Each version is given a distinguishing version number.  If the Program
 *  specifies a version number of this License which applies to it and "any
 *  later version", you have the option of following the terms and conditions
 *  either of that version or of any later version published by the Free
 *  Software Foundation.  If the Program does not specify a version number of
 *  this License, you may choose any version ever published by the Free Software
 *  Foundation.

 *    10. If you wish to incorporate parts of the Program into other free
 *  programs whose distribution conditions are different, write to the author
 *  to ask for permission.  For software which is copyrighted by the Free
 *  Software Foundation, write to the Free Software Foundation; we sometimes
 *  make exceptions for this.  Our decision will be guided by the two goals
 *  vof preserving the free status of all derivatives of our free software and
 *  of promoting the sharing and reuse of software generally.
 *
 *  			    NO WARRANTY
 *
 *    11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
 *  FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
 *  OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
 *  PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
 *  OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
 *  TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
 *  PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
 *  REPAIR OR CORRECTION.
 *
 *    12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
 *  WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
 *  REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
 *  INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
 *  OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
 *  TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
 *  YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
 *  PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
 *  POSSIBILITY OF SUCH DAMAGES.
 *
 *  		     END OF TERMS AND CONDITIONS
 *  
 *  	    How to Apply These Terms to Your New Programs
 *    If you develop a new program, and you want it to be of the greatest
 *  possible use to the public, the best way to achieve this is to make it
 *  free software which everyone can redistribute and change under these terms.
 *
 *    To do so, attach the following notices to the program.  It is safest
 *  to attach them to the start of each source file to most effectively
 *  convey the exclusion of warranty; and each file should have at least
 *  the "copyright" line and a pointer to where the full notice is found.
 *
 *      <one line to give the program's name and a brief idea of what it does.>
 *      Copyright (C) <year>  <name of author>
 *
 *      This program is free software; you can redistribute it and/or modify
 *      it under the terms of the GNU General Public License as published by
 *      the Free Software Foundation; either version 2 of the License, or
 *      (at your option) any later version.
 *
 *      This program is distributed in the hope that it will be useful,
 *      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *      GNU General Public License for more details.
 *
 *      You should have received a copy of the GNU General Public License
 *      along with this program; if not, write to the Free Software
 *      Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 *
 *  Also add information on how to contact you by electronic and paper mail.
 *
 *  If the program is interactive, make it output a short notice like this
 *  when it starts in an interactive mode:
 *
 *      Gnomovision version 69, Copyright (C) year name of author
 *      Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
 *      This is free software, and you are welcome to redistribute it
 *      under certain conditions; type `show c' for details.
 *
 *  The hypothetical commands `show w' and `show c' should show the appropriate
 *  parts of the General Public License.  Of course, the commands you use may
 *  be called something other than `show w' and `show c'; they could even be
 *  mouse-clicks or menu items--whatever suits your program.
 *
 *  You should also get your employer (if you work as a programmer) or your
 *  school, if any, to sign a "copyright disclaimer" for the program, if
 *  necessary.  Here is a sample; alter the names:
 *
 *    Yoyodyne, Inc., hereby disclaims all copyright interest in the program
 *    `Gnomovision' (which makes passes at compilers) written by James Hacker.
 *
 *    <signature of Ty Coon>, 1 April 1989
 *    Ty Coon, President of Vice

 *  This General Public License does not permit incorporating your program into
 *  proprietary programs.  If your program is a subroutine library, you may
 *  consider it more useful to permit linking proprietary applications with the
 *  library.  If this is what you want to do, use the GNU Library General
 *  Public License instead of this License.

*/
package it.aco.mandragora.dao.impl.ojb.pb.core.impl;


import org.apache.ojb.broker.*;
import org.apache.ojb.broker.core.ValueContainer;
import org.apache.ojb.broker.util.ObjectModification;
import org.apache.ojb.broker.util.BrokerHelper;
import org.apache.ojb.broker.util.ClassHelper;
import org.apache.ojb.broker.query.*;
import org.apache.ojb.broker.metadata.*;
import org.apache.ojb.broker.metadata.fieldaccess.PersistentField;
import org.apache.commons.beanutils.PropertyUtilsBean;
import org.apache.commons.beanutils.BeanUtilsBean;
import org.apache.commons.beanutils.ConstructorUtils;
import it.aco.mandragora.exception.OjbPbCoreException;
import it.aco.mandragora.dao.impl.ojb.pb.core.OjbPbCore;
import it.aco.mandragora.dao.impl.ojb.IdentityPaths;
import it.aco.mandragora.dao.impl.ojb.IdentityPath;
import it.aco.mandragora.dao.impl.ojb.ValueObjectToLinkAndStoreMap;
import it.aco.mandragora.query.LogicCondition;
import it.aco.mandragora.query.SimpleCondition;
import it.aco.mandragora.query.Operator;
import it.aco.mandragora.common.Utils;
import it.aco.mandragora.common.utils.BeanCollectionUtils;

import java.util.*;
import java.util.ArrayList;
import java.util.Vector;
import java.lang.reflect.InvocationTargetException;

public class BaseOjbPbCore implements OjbPbCore{



    // Create Log4j category instance for logging
    static private org.apache.log4j.Category log = org.apache.log4j.Logger.getLogger(BaseOjbPbCore.class.getName());

    protected final static int ONE_TO_ONE = 0;
    protected final static int ONE_TO_N = 1;
    protected final static int M_TO_N = 2;

    public Object findByPrimaryKey(Class realClass,Object[] pkValues, PersistenceBroker broker)throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker) ***************");
        Object result;
        try{
            FieldDescriptor[] pkFields = broker.getClassDescriptor(realClass).getPkFields();
            if (pkFields == null || pkValues==null || pkFields.length!=pkValues.length){
                throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker): pkValues not coherent with keys ");
            }
            String[] fieldNames = new String[pkFields.length];
            for (int i=0; i<pkFields.length ;i++){
                fieldNames[i]=pkFields[i].getAttributeName();
            }
            Identity oid = broker.serviceIdentity().buildIdentity(realClass, fieldNames, pkValues);
            result =  broker.getObjectByIdentity(oid);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findByPrimaryKey(Class realClass, Object[] pkValues, PersistenceBroker broker)***************");
        return result;
    }


    public Object findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker)throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker) ***************");
        Object result;
        try{
            Identity oid = broker.serviceIdentity().buildIdentity(realClass, pkFieldNames, pkValues);
            result =  broker.getObjectByIdentity(oid);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findByPrimaryKey(Class realClass,String[] pkFieldNames, Object[] pkValues, PersistenceBroker broker)***************");
        return result;
    }

    public Object findByPrimaryKey(Class realClass, Object pkValue, PersistenceBroker broker)throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker) ***************");
        Object result;
        try{
            Identity oid = broker.serviceIdentity().buildIdentity(realClass, pkValue);
            result =  broker.getObjectByIdentity(oid);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findByPrimaryKey(Class realClass, java.lang.Object pkValue, PersistenceBroker broker)***************");
        return result;
    }





    public Object findObjectByTemplate(Object templateVO, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) ***************");
        Object result;
        try{
            QueryByCriteria query = new QueryByCriteria(templateVO);
            result = broker.getObjectByQuery(query);

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findObjectByTemplate(Object templateVO, PersistenceBroker broker) ***************");
        return result;
    }





    public Collection findCollectionByTemplate(Object templateVO, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByTemplate(Object templateVO, PersistenceBroker broker) ***************");
        Collection result;
        try{
            //log.info("************BaseOjbPbCore.findCollectionByTemplate(ValueObject templateVO, PersistenceBroker broker)***************"+templateVO.getClass());
            QueryByCriteria query = new QueryByCriteria(templateVO);
            result = broker.getCollectionByQuery(query);

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.findCollectionByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.findCollectionByTemplate(templateVO Object, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.findCollectionByTemplate(templateVO Object, PersistenceBroker broker) ***************");
        return result;
    }



    public Collection findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker) ***************");
        Collection result;
        try{
            QueryByCriteria query = new QueryByCriteria(templateVO);
            if (asc==null || asc.booleanValue()){
            	query.addOrderByAscending(orderingField);
            }else query.addOrderByDescending(orderingField);
            result = broker.getCollectionByQuery(query);

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByTemplate(Object templateVO, String orderingField, Boolean asc, PersistenceBroker broker)***************");
        return result;
    }

    public Collection findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker)***************");
        Collection result ;
        try{

            Criteria criteria = new Criteria();
            for (int i = 0; i< nullFields.length; i++){
                criteria.addIsNull(nullFields[i]);
            }
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);


        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByNullFields(Class realClass, String[] nullFields, PersistenceBroker broker)***************");
        return result;
    }


    public Collection findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition, PersistenceBroker broker) throws OjbPbCoreException{

            return findCollectionByLogicCondition( realClass, logicCondition,null, null, null, null,  broker);

    }


    public Collection findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker)***************");
        Collection result;
        try{
            Criteria criteria = translateLogicCondition(broker,realClass,logicCondition);
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);


            if (orderingField !=null && !orderingField.trim().equals("")){
                if (asc==null ||asc.booleanValue()){
                    query.addOrderByAscending(orderingField);
                }else query.addOrderByDescending(orderingField);
            }

            if(startAtIndex!=null)query.setStartAtIndex(startAtIndex.intValue());
            if(endAtIndex!=null)query.setEndAtIndex(endAtIndex.intValue());
            result = broker.getCollectionByQuery(query);


        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField,Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByLogicCondition(Class realClass,LogicCondition logicCondition,String orderingField, Boolean asc,Integer startAtIndex, Integer endAtIndex, PersistenceBroker broker)***************");
        return result;
    }



    private Criteria translateLogicCondition(PersistenceBroker broker,Class realClass,LogicCondition logicCondition) throws Exception{
        Criteria criteria;
        try{
            criteria = translateSimpleCondition(broker,realClass,logicCondition.getSimpleCondition());
            if (logicCondition.getLogicCondition()!=null){
                if (logicCondition.getAndOr().equalsIgnoreCase("AND")){
                    criteria.addAndCriteria(translateLogicCondition(broker,realClass,logicCondition.getLogicCondition()));
                }else if (logicCondition.getAndOr().equalsIgnoreCase("OR")){
                    criteria.addOrCriteria(translateLogicCondition(broker,realClass,logicCondition.getLogicCondition()));
                } else throw new Exception("Error in  BaseOjbPbCore.translateLogicCondition(PersistenceBroker broker,Class realClass,LogicCondition logicCondition): AND/OR missing");
            }
        }
        catch (Exception e){
            log.error("Exception thrown in  BaseOjbPbCore.translateLogicCondition(PersistenceBroker broker,Class realClass,LogicCondition logicCondition): " + e.toString());
            throw new Exception("Error in  BaseOjbPbCore.translateLogicCondition(PersistenceBroker broker,Class realClass,LogicCondition logicCondition): " + e.toString(),e);

        }
        return criteria;
    }

    private Criteria translateSimpleCondition(PersistenceBroker broker,Class realClass, SimpleCondition simpleCondition) throws Exception{
        Criteria criteria = new Criteria();
        String field = null;
        Object value = null;
        try {
            Operator operator=  simpleCondition.getOperator();
            Collection parameters =  simpleCondition.getParameter();
            Iterator iterator = parameters.iterator();
            if (iterator.hasNext()){
                field = (String)iterator.next();
            }
            if (iterator.hasNext()){
                value =  iterator.next();
            }

            /**********************  operators mapping ********************************************/
            if (operator.getName().equalsIgnoreCase("==")||operator.getName().equalsIgnoreCase("=")){
                criteria.addEqualTo(field,value);
            }else if(operator.getName().equalsIgnoreCase("isNull")) {
                criteria.addIsNull(field);
                ClassDescriptor cld = broker.getClassDescriptor(realClass);
                FieldDescriptor fld = cld.getFieldDescriptorByName(field);
                if(fld.getColumnType().equalsIgnoreCase("VARCHAR")){
                    Criteria criteriaEmptyString = new Criteria();
                    criteriaEmptyString.addEqualTo(field,"");
                    criteria.addOrCriteria(criteriaEmptyString);
                }
            }else if(operator.getName().equalsIgnoreCase("isNotNull")) {
                criteria.addNotNull(field);
            } else if(operator.getName().equalsIgnoreCase("IN")) { //added 29/08/2005
                if(value!=null&&!((Collection)value).isEmpty())  criteria.addIn(field,(Collection)value);
            }  else if(operator.getName().equalsIgnoreCase("NOT IN")) {
                if(value!=null&&!((Collection)value).isEmpty()) criteria.addNotIn(field,(Collection)value);
            } else if(operator.getName().equalsIgnoreCase("<=")) {
                criteria.addLessOrEqualThan(field,value);
            } else if(operator.getName().equalsIgnoreCase(">=")) {
                criteria.addGreaterOrEqualThan(field,value);
            }else if(operator.getName().equalsIgnoreCase("<")) {
                criteria.addLessThan(field,value);
            }else if(operator.getName().equalsIgnoreCase(">")) {
                criteria.addGreaterThan(field,value);
            }else if(operator.getName().equalsIgnoreCase("!=")||operator.getName().equalsIgnoreCase("<>")) {
                criteria.addNotEqualTo(field,value);
            }else if(operator.getName().equalsIgnoreCase("LEFTLIKE")) {
                criteria.addLike(field,"%"+value);
            }else if(operator.getName().equalsIgnoreCase("RIGHTLIKE")) {
                criteria.addLike(field,value+"%");
            }else if(operator.getName().equalsIgnoreCase("LIKE")||operator.getName().equalsIgnoreCase("BOTHLIKE")) {
                criteria.addLike(field,"%"+value+"%");
            }


            /********************** end  operators mapping ********************************************/
        }
        catch (Exception e){
            log.error("Exception thrown in  BaseOjbPbCore.translateSimpleCondition(PersistenceBroker broker,Class realClass, SimpleCondition simpleCondition): " + e.toString());
            throw new Exception("Error in  BaseOjbPbCore.translateSimpleCondition(PersistenceBroker broker,Class realClass, SimpleCondition simpleCondition): " + e.toString(),e);

        }
        return criteria;
    }



    public Collection findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker)***************");
        Collection result;
        try{
            if(valuesCollection == null || valuesCollection.isEmpty()){
                return null;
            }
            Criteria criteria = new Criteria();
            Iterator iterator = valuesCollection.iterator();
            while (iterator.hasNext()){
                Criteria criteriaOr = new Criteria();
                Object value = new Object();
                value = iterator.next();
                if (value!=null){
                    criteriaOr.addEqualTo(pAttributeName, value);
                }else{
                    criteriaOr.addIsNull(pAttributeName);
                }


                criteria.addOrCriteria(criteriaOr);
            }

            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);


        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByOrValues(Class realClass,String property,Collection valuesCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByOrValues(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker)***************");
        return result;
    }

    /**
     * Looks for all instaces of <code>realClass</code> which has each field in properties not equals to the correspondent value in values <code>(pAttributeNames[i]!=valuesArray[i])</code>
     * if <code>(valuesArray == null || pAttributeNames == null || valuesArray.length!=pAttributeNames.length)</code> a DataAccessException is thrown
     * If arrays are empty all instances are returned
     * @param realClass  Class which instances have to looked for
     * @param pAttributeNames fields to be compared
     * @param valuesArray values to be compared
     * @param broker PersistenceBroker instance that performs the operation
     * @return  all instances of realClass where <code>pAttributeNames[i]!=valuesArray[i]</code> for all <code>i</code>.
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public Collection findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker)***************");
        Collection result;
        try{
            if(valuesArray == null || pAttributeNames == null || valuesArray.length!=pAttributeNames.length){
                throw new OjbPbCoreException("OjbPbCoreException in OjbPbDAO.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker): pAttributeNames and values must not be null and must have the same length ");
            }
            Criteria criteria = new Criteria();
            for (int i=0;i<pAttributeNames.length;i++){
                criteria.addNotEqualTo(pAttributeNames[i],valuesArray[i]);
            }
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] properties,pAttributeNames[] valuesArray, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByFieldsNotEqualsToValues(Class realClass,String[] pAttributeNames,Object[] valuesArray, PersistenceBroker broker)***************");
        return result;
    }

    /**
     * This methods returns a collection of instances of the class <code>realClass</code> which satisfy <code>pAttributeNames[i] operators[i] valuesArray[i]</code> for each <code>i</code>. <br/>
     * For example:  <code>color = "red" and price "<=" 10000</code>.<br/>
     * Operators supported are: <code>==,=,<=,>=,<,>,!=,<></code><br/>
     * if <code>(valuesArray == null || pAttributeNames == null || operators==null || valuesArray.length!=pAttributeNames.length || operators.length!=pAttributeNames.length)</code>
     *  a DataAccessException is thrown.
     *  If arrays are empty all instances are returned
     * @param realClass Class which instances have to looked for
     * @param pAttributeNames names of the fields to be compared
     * @param operators operators to use to compare
     * @param valuesArray array of the values to be compared
     * @param broker PersistenceBroker instance that performs the operation
     * @return  a collection of instances of the class <code>realClass</code> which satisfy <code>pAttributeNames[i] operators[i] valuesArray[i]</code> for each <code>i</code>.
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public Collection findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker)***************");
        Collection result;
        try{
            if(valuesArray == null || pAttributeNames == null || operators==null || valuesArray.length!=pAttributeNames.length || operators.length!=pAttributeNames.length){
                throw new OjbPbCoreException("OjbPbCoreException in BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker):properties,operators and values must not be null and must have the same length ");
            }
            Criteria criteria = new Criteria();

            for (int i=0;i<pAttributeNames.length;i++){
                if (operators[i].equalsIgnoreCase("==")||operators[i].equalsIgnoreCase("=")){
                    criteria.addEqualTo(pAttributeNames[i],valuesArray[i]);
                }else if(operators[i].equalsIgnoreCase("<=")) {
                    criteria.addLessOrEqualThan(pAttributeNames[i],valuesArray[i]);
                } else if(operators[i].equalsIgnoreCase(">=")) {
                    criteria.addGreaterOrEqualThan(pAttributeNames[i],valuesArray[i]);
                }else if(operators[i].equalsIgnoreCase("<")) {
                    criteria.addLessThan(pAttributeNames[i],valuesArray[i]);
                }else if(operators[i].equalsIgnoreCase(">")) {
                    criteria.addGreaterThan(pAttributeNames[i],valuesArray[i]);
                }else if(operators[i].equalsIgnoreCase("!=")||operators[i].equalsIgnoreCase("<>")) {
                    criteria.addNotEqualTo(pAttributeNames[i],valuesArray[i]);
                }
            }
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  OjbPbCoreException in BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  OjbPbCoreException in BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  OjbPbCoreException in BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  OjbPbCoreException in BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.findCollectionByAndFieldsOperatorValues(Class realClass,String[] pAttributeNames, String[] operators,Object[] valuesArray, PersistenceBroker broker)***************");
        return result;
    }




    public Collection findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker )***************");
        Collection result;
        try{
            if(valuesMatrix  == null || pAttributeNames == null || operators==null || operators.length!=pAttributeNames.length || operators.length==0){
                throw new OjbPbCoreException("OjbPbCoreException in BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ):pAttributeNames and operators  must not be null,  must have the same length and can't be empty ");
            }
            if (valuesMatrix.length==0) throw new OjbPbCoreException("OjbPbCoreException in BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ):valuesMatrix must not be empty");
            Criteria orCriteria = new Criteria();
            for (int i=0; i<valuesMatrix .length; i++){
                Criteria andCriteria= new Criteria();
                if (valuesMatrix[i].length!=pAttributeNames.length) throw new OjbPbCoreException("OjbPbCoreException in BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ):valuesMatrix["+i+"] have the same length of pAttributeNames");
                for (int j=0; j<valuesMatrix[i].length;j++){
                    if (operators[j].equalsIgnoreCase("==")||operators[j].equalsIgnoreCase("=")){
                        andCriteria.addEqualTo(pAttributeNames[j],valuesMatrix[i][j]);
                    }else if(operators[j].equalsIgnoreCase("<=")) {
                        andCriteria.addLessOrEqualThan(pAttributeNames[j],valuesMatrix[i][j]);
                    } else if(operators[j].equalsIgnoreCase(">=")) {
                        andCriteria.addGreaterOrEqualThan(pAttributeNames[j],valuesMatrix[i][j]);
                    }else if(operators[j].equalsIgnoreCase("<")) {
                        andCriteria.addLessThan(pAttributeNames[j],valuesMatrix[i][j]);
                    }else if(operators[j].equalsIgnoreCase(">")) {
                        andCriteria.addGreaterThan(pAttributeNames[j],valuesMatrix[i][j]);
                    }else if(operators[j].equalsIgnoreCase("!=")||operators[j].equalsIgnoreCase("<>")) {
                        andCriteria.addNotEqualTo(pAttributeNames[j],valuesMatrix[i][j]);
                    }
                }
                orCriteria.addOrCriteria(andCriteria);
            }
            QueryByCriteria query = QueryFactory.newQuery(realClass, orCriteria);
            result = broker.getCollectionByQuery(query);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker ): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.findCollectionByArrayOfFieldsOperatorsMatrixAndOrValues(Class realClass,String[] pAttributeNames, String[] operators,Object[][] valuesMatrix, PersistenceBroker broker )***************");
        return result;
    }


    /**
     * Looks for all instances of realClass which value of field property is equal to one of ones in values
     * @param realClass Class which instances have to looked for
     * @param pAttributeName field whose value has to be in values
     * @param valuesCollection collection of values in which the value of property has to be searched
     * @param broker PersistenceBroker instance that performs the operation
     * @return all instances of realClass which value of field property is equal to one of ones in values
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public Collection findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker)***************");
        Collection result;
        try{
            if(valuesCollection == null || valuesCollection.isEmpty()) return null;
            Criteria criteria = new Criteria();
            criteria.addIn(pAttributeName,valuesCollection);
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.findCollectionByFieldInCollection(Class realClass,String pAttributeName,Collection valuesCollection, PersistenceBroker broker)***************");
        return result;
    }


    /**Looks for all instances of realClass that hold value in one of fields properties (it use Like %value%).
     * @param realClass Class which instances have to looked for
     * @param pAttributeNames fields in which value has to be searched
     * @param value  value to search in properties
     * @param broker PersistenceBroker instance that performs the operation
     * @return all instances of realClass that hold value in one of fields properties
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public Collection searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker)***************");
        Collection result;
        try{
            if (pAttributeNames==null || pAttributeNames.length==0||value==null) return null;
            Criteria criteria = new Criteria();
            for (int i=0; i<pAttributeNames.length;i++ ){
                Criteria criteriaOr = new Criteria();
                criteriaOr.addLike(pAttributeNames[i],("%"+value+"%"));
                criteria.addOrCriteria(criteriaOr);
            }
            QueryByCriteria query = QueryFactory.newQuery(realClass, criteria);
            result = broker.getCollectionByQuery(query);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.searchValueInFields(Class realClass,String[] pAttributeNames, Object value, PersistenceBroker broker)***************");
        return result;
    }

    public Collection getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker)***************");
        //TreeSet  toBeRemovedCollectionTreeSet = null; deleted  by alessandro on 22/03/2008
        //Collection storedCollection = null;
        Collection result = null;
        try {
            // start added by alessandro on 22/03/2008
            if(pAttributeName==null || pAttributeName.trim().equals("")){
                log.error("Error  in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank chacarcters string" );
                throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank chacarcters string");
            }

            Object[] pInstanceKeyValues = getKeyValues(pInstance,broker);
            Vector foreignKeyFieldNames = getInverseForeignKeyFields(pInstance.getClass(),pAttributeName,broker);
            ClassDescriptor cld=broker.getClassDescriptor(pInstance.getClass());
            CollectionDescriptor collectionDescriptor = cld.getCollectionDescriptorByName(pAttributeName);
            //Class pAttributeClass = getClassFromPath(pInstance.getClass(),pAttributeName,broker);

            Class pAttributeClass = collectionDescriptor.getItemClass();

            String[] pAttributePkNames = getPkNames(pAttributeClass,broker);

            Criteria criteria = new Criteria();



            for (int k=0; k<foreignKeyFieldNames.size();k++){
                criteria.addEqualTo((String) foreignKeyFieldNames.get(k), pInstanceKeyValues[k]);
                log.debug("getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): foreignKeyFieldName = "+foreignKeyFieldNames.get(k));
                log.debug("getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): pInstanceKeyValues["+k+"] = "+ pInstanceKeyValues[k]);
                k++;
            }

            ReportQueryByCriteria query = QueryFactory.newReportQuery(pAttributeClass, criteria);
            query.setAttributes(pAttributePkNames);
            Iterator iterator = broker.getReportQueryIteratorByQuery(query);
            ArrayList identities = new ArrayList();
            if(iterator!=null){
                while (iterator.hasNext()){
                    Object[] pkValues = (Object[]) iterator.next();
                    identities.add(broker.serviceIdentity().buildIdentity(pAttributeClass,pAttributePkNames,  pkValues));

                }
            }
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            Collection collection= (Collection) propertyUtilsBean.getProperty(pInstance,pAttributeName);
            Iterator identitiesIterator;
            if(collection !=null){
                iterator = collection.iterator();
                while (iterator.hasNext()){
                    Object collectionItem = iterator.next();
                    Identity collectionItemIdentity = broker.serviceIdentity().buildIdentity(collectionItem);
                    identitiesIterator = identities.iterator();
                    while (identitiesIterator.hasNext()){
                        if(((Identity)collectionItemIdentity).equals((Identity)identitiesIterator.next())) {
                            identitiesIterator.remove();
                            break;
                        }
                    }
                }
            }
            result = (Collection) ConstructorUtils.invokeConstructor(collectionDescriptor.getCollectionClass(),null,null) ;
            identitiesIterator = identities.iterator();
            while (identitiesIterator.hasNext()){
                result.add(broker.getObjectByIdentity((Identity) identitiesIterator.next()));
            }

            // end added by alessandro on 22/03/2008
            /* deleted  by alessandro on 22/03/2008
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            Collection collection= (Collection) propertyUtilsBean.getProperty(pInstance,pAttributeName);
            Class pAttributeClass = getClassFromPath(pInstance.getClass(),pAttributeName,broker); deleted by alessandro on 22/03/2008

            storedCollection = getStoredCollection(pInstance,pAttributeName,broker);


            String[] pAttributePkNames= getPkNames(pAttributeClass,broker);  deleted by alessandro on 22/03/2008
            toBeRemovedCollectionTreeSet =  new TreeSet(new FieldComparator(pAttributePkNames));
            if(storedCollection!=null) toBeRemovedCollectionTreeSet.addAll(storedCollection);

            if(collection!=null){
                log.debug("getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName):storedCollection):collection "+collection.toString());
                Iterator collectionIterator = collection.iterator();
                while (collectionIterator.hasNext()){
                    toBeRemovedCollectionTreeSet.remove(collectionIterator.next());
                }
                //toBeRemovedCollectionTreeSet.removeAll(collection);  doesn't work
            }
            log.debug("BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker):storedCollection:toBeRemovedCollectionTreeSet  "+toBeRemovedCollectionTreeSet.toString());
            */
        } catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("NoSuchMethodException thrown in BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("IllegalAccessException thrown in BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            log.error("InvocationTargetException thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("InvocationTargetException thrown in BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (InstantiationException e) {
            log.error("InstantiationException thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getCollectionOfStoredItemsNotInBean(Object pInstance, String pAttributeName, PersistenceBroker broker) ***************");
        //return  toBeRemovedCollectionTreeSet;
        return  result;
    }



    public Collection getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) ***************");
        Collection   storedCollection = null;
        try {
            // start deleted by alessandro on 22/03/2008
            if(pAttributeName==null || pAttributeName.trim().equals("")){
                log.error("Error  in  BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank chacarcters string" );
                throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank chacarcters string");
            }
            // end deleted by alessandro on 22/03/2008


            Object[] itemKeyValues = getKeyValues(pInstance,broker);
            Vector foreignKeyFieldNames = getInverseForeignKeyFields(pInstance.getClass(),pAttributeName,broker);

            Class pAttributeClass = getClassFromPath(pInstance.getClass(),pAttributeName,broker);

            Criteria criteria = new Criteria();

            Iterator iterator =   foreignKeyFieldNames.iterator();
            int k=0;
            while (iterator.hasNext()){
                String foreignKeyFieldName = new String();
                foreignKeyFieldName=(String) iterator.next();
                criteria.addEqualTo(foreignKeyFieldName, itemKeyValues[k]);
                log.debug("getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker): foreignKeyFieldName = "+foreignKeyFieldName);
                log.debug("getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker): itemKeyValues["+k+"] = "+itemKeyValues[k]);
                k++;
            }

            QueryByCriteria query = QueryFactory.newQuery(pAttributeClass, criteria);
            storedCollection = broker.getCollectionByQuery(query);

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getStoredCollection(Object pInstance, String pAttributeName, PersistenceBroker broker) ***************");
        return  storedCollection;
    }



    public Iterator getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker)***************");
        Iterator iter ;
        try{
            if (pAttributeNames == null || pAttributeNames.length==0){
                log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): attributes can't be null nor empty");
                throw new OjbPbCoreException("Error in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): attributes can't be null nor empty");
            }
            if (logicCondition == null){
                log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): logicCondition can't be null ");
                throw new OjbPbCoreException("Error in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): logicCondition can't be null");
            }
            Criteria criteria = translateLogicCondition(broker,realClass,logicCondition);
            ReportQueryByCriteria q = QueryFactory.newReportQuery(realClass, criteria);
            q.setAttributes(pAttributeNames);
            if (groupBy!=null && groupBy.length>0){
                q.addGroupBy(groupBy);
            }
            Iterator iterator = broker.getReportQueryIteratorByQuery(q);
            ArrayList arrayList = new ArrayList();
            if(iterator!=null){
                while (iterator.hasNext()){
                    arrayList.add(iterator.next());
                }
            }
            iter=arrayList.iterator();
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getReportQueryIterator(Class realClass,LogicCondition logicCondition, String[] pAttributeNames, String[] groupBy, PersistenceBroker broker)***************");
        return iter;
    }







    public void retrieveReference(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker)***************");
        try{
            broker.retrieveReference(pInstance,pAttributeName);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.retrieveReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker)***************");
    }

    public void retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker)***************");
        try{
            Iterator iterator = valueObjectsCollection.iterator();
            while (iterator.hasNext()){
                broker.retrieveReference(iterator.next(),pAttributeName);
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.retrieveReferenceInCollection(Collection valueObjectsCollection, String pAttributeName, PersistenceBroker broker)***************");
    }

    public void retrieveAllReferences(Object pInstance, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker)***************");
        try{
            broker.retrieveAllReferences(pInstance);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance, PersistenceBroker broker)***************");
    }

    public void retrieveAllReferencesInCollection(Collection valueObjectsCollection, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveAllReferences(java.lang.Object pInstance)***************");
        try{
            Iterator iterator = valueObjectsCollection.iterator();
            while (iterator.hasNext()){
                broker.retrieveAllReferences(iterator.next());
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveAllReferencesInCollection(Collection valueObjectsCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveAllReferencesInCollection(Collection valueObjectsCollection, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveAllReferencesInCollection(Collection valueObjectsCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveAllReferencesInCollection(Collection valueObjectsCollection, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.retrieveAllReferencesInCollection(Collection valueObjectsCollection)***************");
    }

    public void retrieveNullReference(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker)***************");
        try{
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            if (propertyUtilsBean.getProperty(pInstance,pAttributeName)==null){
                broker.retrieveReference(pInstance,pAttributeName);
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException thrown in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (InvocationTargetException e) {
            log.error("InvocationTargetException thrown in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException thrown in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.retrieveNullReference(java.lang.Object pInstance, java.lang.String pAttributeName, PersistenceBroker broker)***************");
    }

    public void retrieveAllNullReferences(Object pInstance, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker)***************");
        ClassDescriptor cld;
        CollectionDescriptor cold;
        ObjectReferenceDescriptor ord;
        String name;
        Iterator iterator;
        try{
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            cld = broker.getClassDescriptor(pInstance.getClass());
            iterator = cld.getCollectionDescriptors().iterator();
            while(iterator.hasNext()){
                cold=(CollectionDescriptor)iterator.next();
                name = cold.getAttributeName();
                if (propertyUtilsBean.getProperty(pInstance,name)==null){
                    retrieveReference(pInstance,name,broker);
                }
            }
            iterator=cld.getObjectReferenceDescriptors().iterator();
            while(iterator.hasNext()){
                ord=(ObjectReferenceDescriptor)iterator.next();
                name = ord.getAttributeName();
                if (propertyUtilsBean.getProperty(pInstance,name)==null){
                    retrieveReference(pInstance,name,broker);
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in  BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString(),e);
        } catch (NoSuchMethodException e) {
            throw new OjbPbCoreException("NoSuchMethodException thrown in BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker)" + e.toString(),e);
        } catch (IllegalAccessException e) {
            throw new OjbPbCoreException("IllegalAccessException thrown in BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            throw new OjbPbCoreException("InvocationTargetException thrown in BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.retrieveAllNullReferences(java.lang.Object pInstance, PersistenceBroker broker)**************");
    }


    public void retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)***************");
        String firstAttributeName="";
        String remainingPath="";
        try {
            //if (path==null||path.trim().equals("")) return ;
            //if (valueobjectOrCollection==null) return ;
            if (path!=null && !path.trim().equals("") && valueobjectOrCollection!=null){


                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                log.debug("retrievePathReference:path="+path);
                int indexOf=path.indexOf(".");
                if (indexOf==-1) {
                    firstAttributeName=path;
                } else{
                    firstAttributeName=path.substring(0,path.indexOf("."));
                    remainingPath=path.substring(indexOf+1);
                    log.debug("retrievePathReference:remainingPath="+remainingPath);
                }
                log.debug("retrievePathReference:firstAttributeName="+firstAttributeName);

                //if (valueobjectOrCollection.getClass().getInterfaces().length==0){//is a valueobject
                 if (Collection.class.isInstance(valueobjectOrCollection)){ //is a collection
                    log.debug("retrievePathReference: valueobjectOrCollection is a collection");

                    if (valueobjectOrCollection!=null){
                        Iterator iterator = ((Collection) valueobjectOrCollection).iterator();
                        while (iterator.hasNext()){
                            Object valueobjectOrCollectionItem = iterator.next();

                            broker.retrieveReference(valueobjectOrCollectionItem,firstAttributeName);
                            if(indexOf>=0){
                                //retrievePathReference(propertyUtilsBean.getProperty(valueobjectOrCollectionItem,firstAttributeName),remainingPath,broker); deleted by alessandro on 16-03-2008
                                retrieveNullPathReference(propertyUtilsBean.getProperty(valueobjectOrCollectionItem,firstAttributeName),remainingPath,broker); //added by alessandro on 16-03-2008
                            }

                        }
                    }

                } else {//is a valueobject
                    log.debug(".retrievePathReference: valueobjectOrCollection is a valueobject");

                    broker.retrieveReference(valueobjectOrCollection,firstAttributeName);
                    //if(indexOf>=0)retrievePathReference(propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName),remainingPath,broker); deleted by alessandro on 16-03-2008
                    if(indexOf>=0)retrieveNullPathReference(propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName),remainingPath,broker); //added by alessandro on 16-03-2008



                }
            }
        } catch (NoSuchMethodException e) {
            throw new OjbPbCoreException("NoSuchMethodException thrown in BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (IllegalAccessException e) {
            throw new OjbPbCoreException("IllegalAccessException thrown in BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            throw new OjbPbCoreException("InvocationTargetException thrown in BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.retrievePathReference(Object valueobjectOrCollection, String path, PersistenceBroker broker)***************");
    }


    public void retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)***************");
        //String firstAttributeName="";
        //String remainingPath="";
        try {
            //if (path==null||path.trim().equals("")) return ;
            //if (valueobjectOrCollection==null) return ;
            if (path!=null && !path.trim().equals("") && valueobjectOrCollection!=null){


                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                log.debug("retrieveNullPathReference:path="+path);
                // start added by alessandro on 16-02-2008
                String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                String firstAttributeName =firstAttributeNameAndRemainingPath[0];
                String remainingPath = firstAttributeNameAndRemainingPath[1];
                // end added by alessandro on 16-02-2008
                /* delted by alessandro on 16-02-2008
                int indexOf=path.indexOf(".");
                if (indexOf==-1) {
                    firstAttributeName=path;
                } else{
                    firstAttributeName=path.substring(0,path.indexOf("."));
                    remainingPath=path.substring(indexOf+1);
                    log.debug("retrieveNullPathReference:remainingPath="+remainingPath);
                }
                */
                log.debug("retrieveNullPathReference:firstAttributeName="+firstAttributeName);

                if (Collection.class.isInstance(valueobjectOrCollection)){ //is a collection
                    log.debug("retrieveNullPathReference: valueobjectOrCollection is a collection");

                    if (valueobjectOrCollection!=null){
                        Iterator iterator = ((Collection) valueobjectOrCollection).iterator();
                        while (iterator.hasNext()){
                            Object valueobjectOrCollectionItem = iterator.next();
                            if(propertyUtilsBean.getProperty(valueobjectOrCollectionItem,firstAttributeName)==null){
                                broker.retrieveReference(valueobjectOrCollectionItem,firstAttributeName);
                            }
                            //if(indexOf>=0){ // deleted by alessandro on 16-03-2008
                            if(!remainingPath.equals("")){ // added by alessandro on 16-03-2008
                                retrieveNullPathReference(propertyUtilsBean.getProperty(valueobjectOrCollectionItem,firstAttributeName),remainingPath,broker);
                            }
                        }
                    }
                }else{//is a valueobject
                    log.debug(".retrieveNullPathReference: valueobjectOrCollection is a valueobject");

                    //broker.retrieveReference(valueobjectOrCollection,firstAttributeName); deleted by alessandro on 16-03-2008
                    // start added by alessandro on 16-03-2008
                    if(propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName)==null){
                        log.debug("retrieveNullPathReference: propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName)==null");
                        log.debug("retrieveNullPathReference: valueobjectOrCollection = "+valueobjectOrCollection.toString());
                        log.debug("retrieveNullPathReference: firstAttributeName = "+firstAttributeName);
                        broker.retrieveReference(valueobjectOrCollection,firstAttributeName);
                        log.debug("retrieveNullPathReference: retrieved null reference");
                    }
                    //  end added by alessandro on 16-03-2008
                    //if(indexOf>=0)retrievePathReference(propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName),remainingPath,broker);  deleted by alessandro on 16-03-2008
                    if(!remainingPath.equals("")){
                        log.debug("retrieveNullPathReference: before recursion");
                        retrieveNullPathReference(propertyUtilsBean.getProperty(valueobjectOrCollection,firstAttributeName),remainingPath,broker);//  added by alessandro on 16-03-2008
                        log.debug("retrieveNullPathReference: after recursion");
                    }
                }
            }
        } catch (NoSuchMethodException e) {
            throw new OjbPbCoreException("NoSuchMethodException thrown in BaseOjbPbCore.retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (IllegalAccessException e) {
            throw new OjbPbCoreException("IllegalAccessException thrown in BaseOjbPbCore.retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            throw new OjbPbCoreException("InvocationTargetException thrown in BaseOjbPbCore.retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.retrieveNullPathReference(Object valueobjectOrCollection, String path,PersistenceBroker broker) " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.retrievePathReference(Object retrieveNullPathReference, String path, PersistenceBroker broker)***************");
    }
















    public void delete(Object deleteVO, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker)***************");
        if(deleteVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): deleteVO can't be null. ");
        try{

            broker.delete(deleteVO);

        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.delete(ValueObject storeVO, PersistenceBroker broker)****************");

    }



    public void deleteCollection(Collection deleteVOs, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker)***************");
        try{
            if(deleteVOs==null) return;
            Iterator iterator = deleteVOs.iterator();
            while (iterator.hasNext()){
                broker.delete(iterator.next());
            }
        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteCollection(Collection deleteVOs, PersistenceBroker broker) ****************");

    }





    public void deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker)***************");
        try{
            if (rightCollection ==null) log.debug("rightCollection ==null");
            if (left ==null) log.debug("left ==null");
            if(rightCollection ==null || left == null) return;
            if(leftFieldName==null || leftFieldName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker): leftFieldName can't be null empty or blank characters string. ");
            if(rightCollection.isEmpty())log.debug("rightCollection is Empty");
            Iterator iterator = rightCollection.iterator();
            while (iterator.hasNext()){
                Object right = iterator.next();
                log.debug("deleting relationship between "+left.toString()+ " and " +right.toString());
                //broker.deleteMtoNImplementor(new MtoNImplementor(broker, leftFieldName, left, iterator.next()));
                broker.deleteMtoNImplementor(new MtoNImplementor(broker, leftFieldName, left, right));
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteMToNRelationshipCollection(Object left, String leftFieldName, Collection rightCollection, PersistenceBroker broker) ****************");
    }



    public void deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");

        try{
            //if (path==null||path.trim().equals("")) return ;
            //if (rootVO==null) return;
            if(path!=null&&!path.trim().equals("")&&rootVO!=null){

                if(applyDeletePathCascade==null)applyDeletePathCascade=Boolean.TRUE;
                if(ifM2NDeleteOnlyRelationship==null)ifM2NDeleteOnlyRelationship=Boolean.TRUE;
                if(deleteOneToOne==null)deleteOneToOne=Boolean.FALSE;


                ClassDescriptor classDescriptor = broker.getClassDescriptor(rootVO.getClass());

                String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                String firstAttributeName =   firstAttributeNameAndRemainingPath[0];
                String remainingPath =   firstAttributeNameAndRemainingPath[1];

                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                Object firstAttributeValue =  propertyUtilsBean.getProperty(rootVO,firstAttributeName) ;

                ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                if(objectReferenceDescriptor==null) objectReferenceDescriptor = classDescriptor.getCollectionDescriptorByName(firstAttributeName); // added by alessandro 12-nv-2008 todo syocronize with design
                if(CollectionDescriptor.class.isInstance(objectReferenceDescriptor)){
                    Collection<Identity> notInBeanReferencedIdentities = getNotInBeanReferencedIdentities(rootVO, firstAttributeName,broker);
                    if(applyDeletePathCascade.booleanValue()){
                        if(notInBeanReferencedIdentities!=null){
                            Iterator<Identity> iterator = notInBeanReferencedIdentities.iterator();
                            while(iterator.hasNext()){
                                //deleteIdentityPathCascade((Identity)iterator.next(), remainingPath, ifM2NDeleteOnlyRelationship,deleteOneToOne,broker); //deleted by Alessandro on 12-nov-2008 todo syncronize design
                                // start added by Alessandro on 12-nov-2008 todo syncronize design
                                Identity notInBeanReferencedIdentity = iterator.next();
                                if(((CollectionDescriptor)objectReferenceDescriptor).isMtoNRelation()) {
                                    broker.deleteMtoNImplementor(new MtoNImplementor(broker, firstAttributeName, rootVO, createObjectFromIdentity(notInBeanReferencedIdentity,broker)));
                                }
                                if(!((CollectionDescriptor)objectReferenceDescriptor).isMtoNRelation() || !ifM2NDeleteOnlyRelationship) deleteIdentityPathCascade(notInBeanReferencedIdentity, remainingPath, ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                                // end added by Alessandro on 12-nov-2008

                            }
                        }
                    }  else{
                        //  notInBeanReferencedIdentities == null case managed by   deleteReferencedIdentitiesCollection;
                        deleteReferencedIdentitiesCollection(rootVO, firstAttributeName, notInBeanReferencedIdentities, broker, ifM2NDeleteOnlyRelationship);
                    }
                    if(firstAttributeValue !=null){
                        Iterator iterator = ((Collection) firstAttributeValue).iterator();
                        while (iterator.hasNext()){
                            deleteItemsNotInCollectionsInPath(iterator.next(),remainingPath,applyDeletePathCascade,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                        }
                    }
                } else{
                    if(firstAttributeValue!=null){
                        deleteItemsNotInCollectionsInPath(firstAttributeValue,remainingPath,applyDeletePathCascade, ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                    }
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO, String path, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }


    public void deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker)***************");

        try{
            deleteItemsNotInCollectionsInPath(rootVO,path,Boolean.TRUE,Boolean.TRUE,Boolean.FALSE,broker);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker)***************");
    }





    public void deleteItemsNotInCollectionsInPath(Object rootVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path, PersistenceBroker broker)***************");

        try{
            deleteItemsNotInCollectionsInPath(rootVO,path,Boolean.TRUE,ifM2NDeleteOnlyRelationship, deleteOneToOne, broker);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteItemsNotInCollectionsInPath(Object rootVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) ***************");
    }


    public void deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");

        try{
            //if (paths==null||paths.isEmpty()) return ;
            //if (rootVO==null) return;

            if(paths!=null&&!paths.isEmpty()&&rootVO!=null){

                if(pathsHasToBeSorted==null)pathsHasToBeSorted=Boolean.TRUE;
                if(applyDeletePathCascade==null)applyDeletePathCascade=Boolean.TRUE;
                if(ifM2NDeleteOnlyRelationship==null)ifM2NDeleteOnlyRelationship=Boolean.TRUE;
                if(deleteOneToOne==null)deleteOneToOne=Boolean.FALSE;


                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();

                Class rootVOClass = rootVO.getClass();

                //String[] pathsArray = null;
                String[] pathsArray = new String[paths.size()];
                if(pathsHasToBeSorted.booleanValue()){
                    ArrayList<String> pathsList = Collections.list(Collections.enumeration(paths));
                    Collections.sort(pathsList);
                    pathsArray = (String[]) pathsList.toArray(pathsArray);
                }  else{
                    pathsArray = (String[]) paths.toArray(pathsArray);
                }
                int  index = 0;
                while (index < pathsArray.length){
                    String path = pathsArray[index];
                    if(path!= null && !path.trim().equals("")){
                        String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                        String firstAttributeName = firstAttributeNameAndRemainingPath[0];
                        String remainingPath =  firstAttributeNameAndRemainingPath[1];
                        ArrayList<String> subPaths = new ArrayList<String>();
                        if(!remainingPath.trim().equals("")){
                            subPaths.add(remainingPath);
                        }
                        index++;
                        boolean matchingFirstAttributeName = true;
                        while (index < pathsArray.length  && matchingFirstAttributeName){
                            String path2 = pathsArray[index];
                            if(path2!=null && !path2.trim().equals("")) {
                                String[] firstAttributeNameAndRemainingPath2 = Utils.getFirstAttributeNameAndRemainingPath(path2);
                                String firstAttributeName2 = firstAttributeNameAndRemainingPath2[0];
                                String remainingPath2 =  firstAttributeNameAndRemainingPath2[1];
                                if(firstAttributeName.equals(firstAttributeName2)){
                                    if(!remainingPath2.trim().equals("")){
                                        subPaths.add(remainingPath2);
                                    }
                                    index++;
                                } else{
                                    matchingFirstAttributeName=false;
                                }
                            } else{
                                index++;
                            }

                        }
                        if(subPaths.size()>1){
                            ClassDescriptor classDescriptor = broker.getClassDescriptor(rootVOClass);
                            Object firstAttributeValue = propertyUtilsBean.getProperty(rootVO,firstAttributeName);
                            ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                            if(objectReferenceDescriptor==null)  objectReferenceDescriptor  = classDescriptor.getCollectionDescriptorByName(firstAttributeName); //todo syncronize design
                            if(CollectionDescriptor.class.isInstance(objectReferenceDescriptor)){
                                Collection<Identity> notInBeanReferencedIdentities = getNotInBeanReferencedIdentities(rootVO, firstAttributeName, broker);
                                if(((CollectionDescriptor)objectReferenceDescriptor).isMtoNRelation()){
                                    deleteMToNRelationshipIdentitiesCollection(rootVO, firstAttributeName , notInBeanReferencedIdentities,broker);
                                }
                                if(!((CollectionDescriptor)objectReferenceDescriptor).isMtoNRelation() || !ifM2NDeleteOnlyRelationship.booleanValue()){
                                    if(applyDeletePathCascade.booleanValue()){
                                        if(notInBeanReferencedIdentities != null){
                                            Iterator<Identity> iterator =  notInBeanReferencedIdentities.iterator();
                                            while(iterator.hasNext()){
                                                deleteIdentityPathsCascade(iterator.next(),subPaths,Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                                            }
                                        }
                                    } else{
                                        deleteIdentities(notInBeanReferencedIdentities,broker);
                                    }
                                }
                                //if(!((CollectionDescriptor)objectReferenceDescriptor).isMtoNRelation() || ifM2NDeleteOnlyRelationship.booleanValue()){ //condition deleted by Alessandro Colantoni on 17-nov 2008 todo syncronize desing
                                    if(firstAttributeValue!=null){
                                        Iterator iterator = ((Collection)firstAttributeValue).iterator();
                                        while(iterator.hasNext()){
                                            deleteItemsNotInCollectionsInPaths(iterator.next(),subPaths, Boolean.FALSE, applyDeletePathCascade, ifM2NDeleteOnlyRelationship, deleteOneToOne, broker);
                                        }
                                    }
                                //}

                            }else{ //   firstAttributeValue is not a collection
                                deleteItemsNotInCollectionsInPaths(firstAttributeValue,subPaths, Boolean.FALSE, applyDeletePathCascade, ifM2NDeleteOnlyRelationship, deleteOneToOne, broker);
                            }
                        }else { //subPaths.size()<=1
                            deleteItemsNotInCollectionsInPath(rootVO, path, applyDeletePathCascade, ifM2NDeleteOnlyRelationship, deleteOneToOne,broker);
                        }

                    }else{
                        index++;
                    }
                }
            }


        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }

    public void deleteItemsNotInCollectionsInPaths(Object rootVO, Collection paths,  Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection paths,  Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
        deleteItemsNotInCollectionsInPaths(rootVO, paths, Boolean.TRUE, applyDeletePathCascade, ifM2NDeleteOnlyRelationship, deleteOneToOne,broker);
        log.info("************Done with the BaseOjbPbCore.deleteItemsNotInCollectionsInPaths(Object rootVO, Collection paths,  Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }



    //todo try to reuse for deleteInbeanPathCascade
    private void deleteIdentityPathCascade_old(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
        try{
            if(identity!=null){

                if (path == null || path.trim().equals("")){
                    deleteIdentity(identity,broker);
                }else{

                    if(identity.getObjectsRealClass()==null ) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): identity ObjectRealClass can't be null" );

                    ArrayList lastLevelIdentities = new ArrayList();
                    ArrayList toBeDeletedIdentities = new ArrayList();
                    lastLevelIdentities.add(identity);
                    toBeDeletedIdentities.add(identity);

                    ArrayList attributeDescriptorsForPath = broker.getClassDescriptor(identity.getObjectsRealClass()).getAttributeDescriptorsForPath(path);
                    int startIndex=0;
                    int endIndex=0;
                    int pathSize= attributeDescriptorsForPath.size();
                    boolean follow = true;
                    AttributeDescriptorBase attributeDescriptor = null;
                    while(endIndex<pathSize && !lastLevelIdentities.isEmpty() && follow){
                        attributeDescriptor= (AttributeDescriptorBase) attributeDescriptorsForPath.get(endIndex);
                        if(CollectionDescriptor.class.isInstance(attributeDescriptor)){
                            if(((CollectionDescriptor)attributeDescriptor).isMtoNRelation()){
                                if(ifM2NDeleteOnlyRelationship.booleanValue()){
                                    follow=false;
                                }else{
                                    follow=true;
                                }
                            }else{
                                follow=true;
                            }
                        }else if(ObjectReferenceDescriptor.class.isInstance(attributeDescriptor)){
                            if(deleteOneToOne.booleanValue()){
                                follow=true;
                            } else{
                                follow=false;
                            }
                        } else{
                            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): Error:attributeDescriptorsForPath("+endIndex+")  is no ObjectReferenceDescriptor and no CollectionDescriptor" );
                        }


                        if(((ObjectReferenceDescriptor)attributeDescriptor).getCascadingDelete() != ObjectReferenceDescriptor.CASCADE_OBJECT){
                            if(CollectionDescriptor.class.isInstance(attributeDescriptor)) { // is CollectionDescriptor
                                if(((CollectionDescriptor)attributeDescriptor).isMtoNRelation()){
                                    ArrayList newLastLevelIdentities =  new ArrayList();
                                    /*start added by  alessandro on 12-oct-2008 to manage CascadingDelete = link*/
                                    if(((ObjectReferenceDescriptor)attributeDescriptor).getCascadingDelete() == ObjectReferenceDescriptor.CASCADE_LINK){
                                        //if(ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities = getPartialPathIdentities(lastLevelIdentities,attributeDescriptorsForPath, startIndex, endIndex, broker); //deleted by Alessandro on Nov the 10th 2008 todo syncronize design
                                        /*start added by  alessandro on 10-Nov-2008 to manage CascadingDelete = link todo syncronize design */
                                        if(!ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities = getPartialPathIdentities(lastLevelIdentities,attributeDescriptorsForPath, startIndex, endIndex, broker);

                                        /*start added by  alessandro on 10-Nov-2008 to manage CascadingDelete = link*/
                                    }else{    //  CASCADE_NONE

                                    /*end added by  alessandro on 12-oct-2008 to manage CascadingDelete = link*/

                                        Collection withMToNRelationIdentities = getPartialPathIdentities(lastLevelIdentities,attributeDescriptorsForPath, startIndex, endIndex -1, broker);
                                        String leftFieldName = attributeDescriptor.getAttributeName();

                                        Iterator iterator = withMToNRelationIdentities.iterator();// getPartialPathIdentities never returns null!!
                                        while (iterator.hasNext()){
                                            Identity withMToNRelationIdentity = (Identity)  iterator.next();
                                            Object left = createObjectFromIdentity(withMToNRelationIdentity,broker);
                                            Collection referencedIdentities = getIdentityReferencedIdentities(withMToNRelationIdentity, (ObjectReferenceDescriptor)attributeDescriptor, broker );
                                            if(referencedIdentities!=null){
                                                ArrayList rightCollection = new ArrayList();
                                                Iterator referencedIdentitiesIterator = referencedIdentities.iterator();
                                                while(referencedIdentitiesIterator.hasNext()){
                                                    rightCollection.add(createObjectFromIdentity((Identity)referencedIdentitiesIterator.next(),broker));
                                                }
                                                deleteMToNRelationshipCollection(left, leftFieldName, rightCollection,broker);
                                                //if(ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities.addAll(referencedIdentities); //deleted by Alessandro on Nov the 10th 2008 todo syncronize design
                                                if(!ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities.addAll(referencedIdentities); //added by Alessandro on Nov the 10th 2008 todo  syncronize design
                                            }
                                        }
                                    }
                                    Collections.reverse(toBeDeletedIdentities);
                                    deleteIdentities(toBeDeletedIdentities,broker);
                                    lastLevelIdentities = newLastLevelIdentities;
                                    toBeDeletedIdentities.clear();
                                    toBeDeletedIdentities.addAll(lastLevelIdentities);
                                    //toBeDeletedIdentities = newLastLevelIdentities;
                                }else{ //!((CollectionDescriptor)attributeDescriptor).isMtoNRelation()
                                    ArrayList partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, startIndex , endIndex, broker);
                                    toBeDeletedIdentities.addAll(partialPathIdentities);  // getPartialPathIdentities never returns null!!
                                    lastLevelIdentities = partialPathIdentities;

                                }


                            } else{ //  is ObjectReferenceDescriptor
                                ArrayList partialPathIdentities = new ArrayList();
                                if(deleteOneToOne.booleanValue()) partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, startIndex , endIndex, broker);
                                Collections.reverse(toBeDeletedIdentities);
                                deleteIdentities(toBeDeletedIdentities,broker);
                                lastLevelIdentities = partialPathIdentities; // in the case of Not deleteOneToOne partialPathIdentities is empty
                                toBeDeletedIdentities.clear();
                                toBeDeletedIdentities.addAll(partialPathIdentities);
                                //toBeDeletedIdentities = partialPathIdentities;
                            }

                            startIndex = endIndex+1; // added by alessandro on 13-Oct-2008
                        }
                        endIndex++;


                    }
                    Collections.reverse(toBeDeletedIdentities);
                    deleteIdentities(toBeDeletedIdentities,broker);
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }

    private void deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
        try{
            if(identity!=null){

                if (path == null || path.trim().equals("")){
                    deleteIdentity(identity,broker);
                }else{

                    if(identity.getObjectsRealClass()==null ) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): identity ObjectRealClass can't be null" );

                    ArrayList<Identity> lastLevelIdentities = new ArrayList<Identity>();
                    ArrayList<Identity> toBeDeletedIdentities = new ArrayList<Identity>();
                    lastLevelIdentities.add(identity);
                    toBeDeletedIdentities.add(identity);

                    ArrayList attributeDescriptorsForPath = broker.getClassDescriptor(identity.getObjectsRealClass()).getAttributeDescriptorsForPath(path);
                    //int startIndex=0;
                    int endIndex=0;
                    int pathSize= attributeDescriptorsForPath.size();
                    boolean follow = true;
                    AttributeDescriptorBase attributeDescriptor = null;
                    while(endIndex<pathSize && !lastLevelIdentities.isEmpty() && follow){
                        attributeDescriptor= (AttributeDescriptorBase) attributeDescriptorsForPath.get(endIndex);
                        if(CollectionDescriptor.class.isInstance(attributeDescriptor)){
                            if(((CollectionDescriptor)attributeDescriptor).isMtoNRelation()){
                                if(ifM2NDeleteOnlyRelationship.booleanValue()){
                                    follow=false;
                                }else{
                                    follow=true;
                                }
                            }else{
                                follow=true;
                            }
                        }else if(ObjectReferenceDescriptor.class.isInstance(attributeDescriptor)){
                            if(deleteOneToOne.booleanValue()){
                                follow=true;
                            } else{
                                follow=false;
                            }
                        } else{
                            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): Error:attributeDescriptorsForPath("+endIndex+")  is no ObjectReferenceDescriptor and no CollectionDescriptor" );
                        }

                        int cascadingDelete = ((ObjectReferenceDescriptor)attributeDescriptor).getCascadingDelete();
                        log.debug("cascadingDelete = "+cascadingDelete);
                        if(CollectionDescriptor.class.isInstance(attributeDescriptor)) { // is CollectionDescriptor
                            if(((CollectionDescriptor)attributeDescriptor).isMtoNRelation()){
                                ArrayList<Identity> newLastLevelIdentities =  new ArrayList<Identity>();


                                if(cascadingDelete==ObjectReferenceDescriptor.CASCADE_NONE || !ifM2NDeleteOnlyRelationship.booleanValue()){
                                    String leftFieldName = attributeDescriptor.getAttributeName();
                                    //Iterator iterator = withMToNRelationIdentities.iterator();// getPartialPathIdentities never returns null!!
                                    log.debug("lastLevelIdentities.size() = "+lastLevelIdentities.size());
                                    Iterator<Identity> iterator = lastLevelIdentities.iterator();// lastLevelIdentities is never null
                                    while (iterator.hasNext()){
                                        Identity withMToNRelationIdentity =   iterator.next();
                                        Object left = createObjectFromIdentity(withMToNRelationIdentity,broker);
                                        Collection<Identity> referencedIdentities = getIdentityReferencedIdentities(withMToNRelationIdentity, (ObjectReferenceDescriptor)attributeDescriptor, broker );
                                        if(referencedIdentities!=null){
                                            log.debug("referencedIdentities.size() = "+referencedIdentities.size());
                                            if(cascadingDelete==ObjectReferenceDescriptor.CASCADE_NONE){
                                                ArrayList rightCollection = new ArrayList();
                                                Iterator<Identity> referencedIdentitiesIterator = referencedIdentities.iterator();
                                                while(referencedIdentitiesIterator.hasNext()){
                                                    rightCollection.add(createObjectFromIdentity(referencedIdentitiesIterator.next(),broker));
                                                }
                                                deleteMToNRelationshipCollection(left, leftFieldName, rightCollection,broker);
                                            }
                                            //if(ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities.addAll(referencedIdentities); //deleted by Alessandro on Nov the 10th 2008 todo syncronize design
                                            if(!ifM2NDeleteOnlyRelationship.booleanValue()) newLastLevelIdentities.addAll(referencedIdentities); //added by Alessandro on Nov the 10th 2008 todo  syncronize design
                                        }
                                    }
                                }

                                Collections.reverse(toBeDeletedIdentities);
                                deleteIdentities(toBeDeletedIdentities,broker);
                                lastLevelIdentities = newLastLevelIdentities;
                                toBeDeletedIdentities.clear();
                                toBeDeletedIdentities.addAll(lastLevelIdentities);
                                //toBeDeletedIdentities = newLastLevelIdentities;
                            }else{ //!((CollectionDescriptor)attributeDescriptor).isMtoNRelation()
                                //ArrayList partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, startIndex , endIndex, broker);
                                ArrayList<Identity> partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, endIndex , endIndex, broker);
                                toBeDeletedIdentities.addAll(partialPathIdentities);  // getPartialPathIdentities never returns null!!
                                lastLevelIdentities = partialPathIdentities;

                            }


                        } else{ //  is ObjectReferenceDescriptor
                            ArrayList<Identity> partialPathIdentities = new ArrayList<Identity>();
                            //if(deleteOneToOne.booleanValue()) partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, startIndex , endIndex, broker);
                            if(deleteOneToOne.booleanValue()) partialPathIdentities =getPartialPathIdentities(lastLevelIdentities, attributeDescriptorsForPath, endIndex , endIndex, broker);
                            Collections.reverse(toBeDeletedIdentities);
                            deleteIdentities(toBeDeletedIdentities,broker);
                            lastLevelIdentities = partialPathIdentities; // in the case of Not deleteOneToOne partialPathIdentities is empty
                            toBeDeletedIdentities.clear();
                            toBeDeletedIdentities.addAll(partialPathIdentities);
                            //toBeDeletedIdentities = partialPathIdentities;
                        }

                            //startIndex = endIndex+1; // added by alessandro on 13-Oct-2008
                        endIndex++;
                    }
                    Collections.reverse(toBeDeletedIdentities);
                    deleteIdentities(toBeDeletedIdentities,broker);
                }
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentityPathCascade(Identity identity, String path, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }




    private void deleteIdentityPathsCascade(Identity identity, Collection<String> paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection<String> paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
        try{
            if(identity!=null){

                if (paths == null || paths.isEmpty()){
                    deleteIdentity(identity,broker);
                }else{

                    if(identity.getObjectsRealClass()==null ) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection<String> paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): identity ObjectRealClass can't be null" );
                    ClassDescriptor classDescriptor =  broker.getClassDescriptor(identity.getObjectsRealClass());
                    String[] pathsArray = new String[paths.size()];
                    if(pathsHasToBeSorted.booleanValue()){
                        ArrayList<String> pathsList = Collections.list(Collections.enumeration(paths));
                        Collections.sort(pathsList);
                        pathsArray = (String[]) pathsList.toArray(pathsArray);
                    }  else{
                        pathsArray = (String[]) paths.toArray(pathsArray);
                    }
                    int index = 0;

                    HashMap<String,ArrayList<String>> directReferenceMap = new HashMap<String,ArrayList<String>>();

                    HashMap<String,ArrayList<String>> oneToNReferenceMap = new HashMap<String,ArrayList<String>>();

                    HashMap<String,ArrayList<String>> mToNReferenceNoneCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> mToNReferenceLinkOrObjectCascadingStoreMap = new HashMap<String,ArrayList<String>>();




                    while (index<pathsArray.length){
                        String path = pathsArray[index];
                        if(path!=null && !path.trim().equals("")){
                            String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                            String firstAttributeName=firstAttributeNameAndRemainingPath[0];
                            ArrayList<String> subPaths = new ArrayList<String> ();


                            ObjectReferenceDescriptor firstAttributeDescriptor =  classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                            if(firstAttributeDescriptor==null)firstAttributeDescriptor = classDescriptor.getCollectionDescriptorByName(firstAttributeName);
                            if(firstAttributeDescriptor==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection<String> paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)  : attribute "+firstAttributeName+" must be a reference 1To1, 1ToN or MtoN");
                            int cascadingDelete = firstAttributeDescriptor.getCascadingDelete();
                            int relationType = ONE_TO_ONE;
                            if(CollectionDescriptor.class.isInstance(firstAttributeDescriptor)){
                                if(((CollectionDescriptor)firstAttributeDescriptor).isMtoNRelation()){
                                    relationType = M_TO_N;
                                }else{
                                    relationType = ONE_TO_N;
                                }
                            }


                            if(!firstAttributeNameAndRemainingPath[1].trim().equals(""))subPaths.add(firstAttributeNameAndRemainingPath[1]);
                            index++;
                            boolean matchingFirstAttributeName = true;
                            while (index < pathsArray.length  && matchingFirstAttributeName){
                                String path2 = pathsArray[index];
                                if(path2!=null && !path2.trim().equals("")){
                                    String[] firstAttributeNameAndRemainingPath2 = Utils.getFirstAttributeNameAndRemainingPath(path2);
                                    String firstAttributeName2=firstAttributeNameAndRemainingPath2[0];
                                    if(firstAttributeName.equals(firstAttributeName2)){
                                        if(!firstAttributeNameAndRemainingPath2[1].trim().equals("")) subPaths.add(firstAttributeNameAndRemainingPath2[1]);
                                        index++;
                                    }else{
                                        matchingFirstAttributeName=false;
                                    }
                                } else{
                                    index++;
                                }
                            }


                            HashMap<String,ArrayList<String>> map = null;
                            switch (relationType){
                                case ONE_TO_ONE: map = directReferenceMap; break;
                                case ONE_TO_N: map = oneToNReferenceMap;break;
                                case M_TO_N:
                                    switch (cascadingDelete){
                                        case ObjectReferenceDescriptor.CASCADE_NONE: map = mToNReferenceNoneCascadingStoreMap;break;
                                        case ObjectReferenceDescriptor.CASCADE_OBJECT: map = mToNReferenceLinkOrObjectCascadingStoreMap;break;
                                        case ObjectReferenceDescriptor.CASCADE_LINK: map = mToNReferenceLinkOrObjectCascadingStoreMap;break;
                                    }
                            }
                            map.put(firstAttributeName,subPaths);

                        } else {    // added on 19-nov 2008  by ale todo syncronize design uml
                            index++;
                        }
                    }

                    Iterator<String> iterator = oneToNReferenceMap.keySet().iterator();
                    while(iterator.hasNext()) {
                        String firstAttributeName = iterator.next();
                        log.debug("deleteIdentityPathsCascade in oneToNReferenceMap: firstAttributeName = "+firstAttributeName);
                        Collection<Identity> childrenIdentities = getIdentityReferencedIdentities(identity, classDescriptor.getCollectionDescriptorByName(firstAttributeName),broker);
                        if(childrenIdentities!=null){
                            Iterator<Identity> childrenIdentitiesIterator = childrenIdentities.iterator();
                            while(childrenIdentitiesIterator.hasNext()){
                                deleteIdentityPathsCascade(childrenIdentitiesIterator.next(),oneToNReferenceMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                            }
                        }

                    }

                    iterator = mToNReferenceNoneCascadingStoreMap.keySet().iterator();
                    Object left = createObjectFromIdentity(identity,broker);
                    while(iterator.hasNext()) {
                        String firstAttributeName = iterator.next();
                        log.debug("deleteIdentityPathsCascade in mToNReferenceNoneCascadingStoreMap: firstAttributeName = "+firstAttributeName);
                        Collection<Identity> childrenIdentities = getIdentityReferencedIdentities(identity, classDescriptor.getCollectionDescriptorByName(firstAttributeName),broker);
                        deleteMToNRelationshipIdentitiesCollection(left,firstAttributeName,childrenIdentities,broker);
                        if(childrenIdentities!=null && !ifM2NDeleteOnlyRelationship){
                            Iterator<Identity> childrenIdentitiesIterator = childrenIdentities.iterator();
                            while(childrenIdentitiesIterator.hasNext()){
                                deleteIdentityPathsCascade((Identity)childrenIdentitiesIterator.next(),mToNReferenceNoneCascadingStoreMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                            }
                        }
                    }




                    HashMap<String,Collection<Identity>> mToNReferenceLinkOrObjectCascadingStoreReferencedIdentitiesMap= new HashMap<String, Collection<Identity>>();
                    if(!ifM2NDeleteOnlyRelationship){
                        iterator = mToNReferenceLinkOrObjectCascadingStoreMap.keySet().iterator();
                        while(iterator.hasNext()) {
                            String firstAttributeName = iterator.next();
                            log.debug("deleteIdentityPathsCascade in mToNReferenceLinkOrObjectCascadingStoreMap: firstAttributeName = "+firstAttributeName);
                            mToNReferenceLinkOrObjectCascadingStoreReferencedIdentitiesMap.put(firstAttributeName,getIdentityReferencedIdentities(identity, classDescriptor.getCollectionDescriptorByName(firstAttributeName),broker));
                        }
                    }

                    HashMap<String,Identity> directReferenceMapReferencedIdentityMap= new HashMap<String, Identity>();
                    if(deleteOneToOne){
                        iterator = directReferenceMap.keySet().iterator();
                        while(iterator.hasNext()) {
                            String firstAttributeName = iterator.next();
                            log.debug("deleteIdentityPathsCascade in directReferenceMap: firstAttributeName = "+firstAttributeName);
                            directReferenceMapReferencedIdentityMap.put(firstAttributeName, getIdentityReferencedIdentity(identity, classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName),broker));
                        }
                    }

                    deleteIdentity(identity,broker);

                    if(!ifM2NDeleteOnlyRelationship)  {
                        iterator = mToNReferenceLinkOrObjectCascadingStoreMap.keySet().iterator();
                        while(iterator.hasNext()) {
                            String firstAttributeName = iterator.next();
                            log.debug("deleteIdentityPathsCascade in mToNReferenceLinkOrObjectCascadingStoreMap second iteration: firstAttributeName = "+firstAttributeName);

                            Collection<Identity> childrenIdentities = mToNReferenceLinkOrObjectCascadingStoreReferencedIdentitiesMap.get(firstAttributeName);
                            if(childrenIdentities!=null ){ //&& !ifM2NDeleteOnlyRelationship is sure
                                Iterator<Identity> childrenIdentitiesIterator = childrenIdentities.iterator();
                                while(childrenIdentitiesIterator.hasNext()){
                                    deleteIdentityPathsCascade((Identity)childrenIdentitiesIterator.next(),mToNReferenceLinkOrObjectCascadingStoreMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                                }
                            }
                        }
                    }

                    if(deleteOneToOne){
                        iterator = directReferenceMap.keySet().iterator();
                        while(iterator.hasNext()) {
                            String firstAttributeName = iterator.next();
                            log.debug("deleteIdentityPathsCascade in directReferenceMap second iteration: firstAttributeName = "+firstAttributeName);

                            Identity childIdentity = directReferenceMapReferencedIdentityMap.get(firstAttributeName);
                            if(childIdentity==null)log.debug("childIdentity  is null");
                            if(childIdentity!=null){
                                log.debug("childIdentity :"+childIdentity.toString());
                                deleteIdentityPathsCascade(childIdentity,directReferenceMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);

                            }
                        }
                    }


                    /*
                    iterator = mToNReferenceLinkOrObjectCascadingStoreMap.keySet().iterator();
                    while(iterator.hasNext()) {
                        String firstAttributeName = iterator.next();
                        log.debug("deleteIdentityPathsCascade in mToNReferenceLinkOrObjectCascadingStoreMap: firstAttributeName = "+firstAttributeName);

                        Collection<Identity> childrenIdentities = getIdentityReferencedIdentities(identity, classDescriptor.getCollectionDescriptorByName(firstAttributeName),broker);
                        if(childrenIdentities!=null && !ifM2NDeleteOnlyRelationship){
                            Iterator<Identity> childrenIdentitiesIterator = childrenIdentities.iterator();
                            while(childrenIdentitiesIterator.hasNext()){
                                deleteIdentityPathsCascade((Identity)childrenIdentitiesIterator.next(),mToNReferenceLinkOrObjectCascadingStoreMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                            }
                        }
                    }
                    */

                    /*
                    if(deleteOneToOne){
                        iterator = directReferenceMap.keySet().iterator();
                        while(iterator.hasNext()) {
                            String firstAttributeName = iterator.next();
                            log.debug("deleteIdentityPathsCascade in directReferenceMap: firstAttributeName = "+firstAttributeName);

                            Identity childIdentity = getIdentityReferencedIdentity(identity, classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName),broker);
                            if(childIdentity==null)log.debug("childIdentity  is null");
                            if(childIdentity!=null){
                                log.debug("childIdentity :"+childIdentity.toString());
                                deleteIdentityPathsCascade(childIdentity,directReferenceMap.get(firstAttributeName),Boolean.FALSE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);

                            }
                        }
                    }
                    */
                }
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentityPathsCascade(Identity identity, Collection paths, Boolean  pathsHasToBeSorted, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");
    }




    public void deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) throws OjbPbCoreException/*, OptimisticLockException*/{
        log.info("************Entering the BaseOjbPbCore.deletePathCascade(Object parentVO,String path, PersistenceBroker broker)***************");

        try{
            if( parentVO != null){

                if(ifM2NDeleteOnlyRelationship==null)ifM2NDeleteOnlyRelationship=Boolean.TRUE;
                if(deleteOneToOne==null)deleteOneToOne=Boolean.FALSE;


                ClassDescriptor classDescriptor = broker.getClassDescriptor(parentVO.getClass());
                IdentityFactory identityFactory = broker.serviceIdentity();
                Identity identity = identityFactory.buildIdentity(classDescriptor,parentVO);
                identity.setObjectsRealClass(parentVO.getClass());
                deleteIdentityPathCascade(identity,path,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);

            }

        }catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("PersistenceBrokerException thrown in BaseOjbPbCore.deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) )" + e.toString(),e);
        }/* catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.deletePathCascade(Object parentVO,String path, Boolean deleteOneToOne,Boolean ifM2NDeleteOnlyRelationship,PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.deletePathCascade(Object parentVO,String path, Boolean deleteOneToOne,Boolean ifM2NDeleteOnlyRelationship,PersistenceBroker broker): " + e.toString(),e);
        }*/catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deletePathCascade(Object parentVO,String path,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) ***************");

    }


    public void deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker)  ***************");

        try{
            if( parentVO != null){

                if(ifM2NDeleteOnlyRelationship==null)ifM2NDeleteOnlyRelationship=Boolean.TRUE;
                if(deleteOneToOne==null)deleteOneToOne=Boolean.FALSE;

                ClassDescriptor classDescriptor = broker.getClassDescriptor(parentVO.getClass());
                IdentityFactory identityFactory = broker.serviceIdentity();
                Identity identity = identityFactory.buildIdentity(classDescriptor,parentVO);
                identity.setObjectsRealClass(parentVO.getClass());
                deleteIdentityPathsCascade(identity,paths,Boolean.TRUE,ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);

            }

        }catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("PersistenceBrokerException thrown in BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) " + e.toString(),e);
        }catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Exception thrown in BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deletePathsCascade(Object parentVO,Collection paths,Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne,PersistenceBroker broker) ***************");

    }



    /**
     *
     * @param left
     * @param leftFieldName
     * @param rightIdentities
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    private void deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker)***************");
        try{
            if(rightIdentities ==null || rightIdentities.isEmpty()) return;
            Iterator iterator = rightIdentities.iterator();
            ArrayList rightCollection = new ArrayList();
            while (iterator.hasNext()){
                rightCollection.add(createObjectFromIdentity((Identity)iterator.next(), broker));
            }
            deleteMToNRelationshipCollection(left, leftFieldName,rightCollection,broker);
        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) : " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteMToNRelationshipIdentitiesCollection(Object left, String leftFieldName, Collection rightIdentities, PersistenceBroker broker) ****************");
    }

    private void deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker)***************");
        try{
            if(leftIdentity.getObjectsRealClass()==null ) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker): leftIdentity ObjectRealClass can't be null" );
            ClassDescriptor classDescriptor =  broker.getClassDescriptor(leftIdentity.getObjectsRealClass());
            Collection<Identity> rightIdentities = getIdentityReferencedIdentities(leftIdentity, classDescriptor.getCollectionDescriptorByName(leftFieldName),broker);
            if(rightIdentities ==null || rightIdentities.isEmpty()) return;
            Iterator iterator = rightIdentities.iterator();
            ArrayList rightCollection = new ArrayList();
            while (iterator.hasNext()){
                rightCollection.add(createObjectFromIdentity((Identity)iterator.next(), broker));
            }

            deleteMToNRelationshipCollection(createObjectFromIdentity(leftIdentity,broker), leftFieldName,rightCollection,broker);
        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker) : " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentityMToNRelationship(Identity leftIdentity, String leftFieldName,  PersistenceBroker broker)***************");
    }


    /**
     *
     * @param parentVO
     * @param pAttributeName
     * @param toBeDeletedIdentities
     * @param broker
     * @param ifM2NDeleteOnlyRelationship
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private void deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker, Boolean ifM2NDeleteOnlyRelationship) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) **************");

        try{
            if(parentVO ==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) : parentVO can't be null. ");
            if(pAttributeName==null||pAttributeName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker)  : pAttributeName can't be null or empty or blank characters string. ");
            if (toBeDeletedIdentities == null) return;

            ClassDescriptor parentVOClassDescriptor = broker.getClassDescriptor(parentVO.getClass());
            CollectionDescriptor collectionDescriptor = parentVOClassDescriptor.getCollectionDescriptorByName(pAttributeName);

            Class refClass = collectionDescriptor.getItemClass(); // Class of the item of the collection parentVO.pAttributeName

            // start added by alessandro on  27-03-2008
            Iterator toBeDeletedIdentitiesIterator = toBeDeletedIdentities.iterator();

            while (toBeDeletedIdentitiesIterator.hasNext()){
                Identity toBeDeletedIdentity = (Identity) toBeDeletedIdentitiesIterator.next() ;
                if(toBeDeletedIdentity.getObjectsRealClass()!=null)toBeDeletedIdentity.setObjectsRealClass(refClass);

            }

            if(collectionDescriptor.isMtoNRelation()){
                //deleteMToNRelationshipCollection(parentVO,pAttributeName,toBeDeletedIdentities,broker); //Todo change in design
                deleteMToNRelationshipIdentitiesCollection(parentVO,pAttributeName,toBeDeletedIdentities,broker);
                if(!ifM2NDeleteOnlyRelationship.booleanValue()) deleteIdentities(toBeDeletedIdentities,broker);
            } else{
                deleteIdentities(toBeDeletedIdentities,broker);
            }
            // end  added by alessandro on  27-03-2008

            /* deleted  by alessandro on 27-03-2008
            ClassDescriptor refCld = broker.getClassDescriptor(refClass);

            BrokerHelper brokerHelper = broker.serviceBrokerHelper();
            ValueContainer[] container = brokerHelper.getKeyValues(parentVOClassDescriptor,parentVO);

            FieldDescriptor[] refPkFields = refCld.getPkFields();
            String[] refPkFieldNames = new String[refPkFields.length];



            Iterator toBeDeletedIdentitiesIterator = toBeDeletedIdentities.iterator();
            Collection  toDeleteObjectOrMtoNs = new ArrayList();
            while (toBeDeletedIdentitiesIterator.hasNext()){
                Identity toBeDeletedIdentity = (Identity) toBeDeletedIdentitiesIterator.next() ;
                Object toDeleteObjectOrMtoN = ClassHelper.newInstance(refClass);
                Object[] pkValues =  toBeDeletedIdentity.getPrimaryKeyValues();
                for (int i = 0; i < refPkFields.length; i++){
                    refPkFields[i].getPersistentField().set(toDeleteObjectOrMtoN,pkValues[i]);
                }
                toDeleteObjectOrMtoNs.add(toDeleteObjectOrMtoN);
            }

            if(collectionDescriptor.isMtoNRelation()){ // if isMtoNRelation and iterator!=null surely collectionDescriptor.getCascadingStore() != ObjectReferenceDescriptor.CASCADE_NONE
                deleteMToNRelationshipCollection(parentVO,pAttributeName,toDeleteObjectOrMtoNs,broker);
            } else{
                deleteCollection(toDeleteObjectOrMtoNs,broker);
            }
            */
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteReferencedIdentitiesCollection(Object parentVO, String pAttributeName, Collection toBeDeletedIdentities, PersistenceBroker broker) ***************");
    }

    /**
     *
     * @param identity
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private void deleteIdentity(Identity identity,PersistenceBroker broker)  throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker) **************");
        try{
            if(identity!=null){
                Object toBeDeleted = createObjectFromIdentity(identity, broker);
                broker.delete(toBeDeleted);
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentity(Identity identity,PersistenceBroker broker) ***************");
    }

    /**
     *
     * @param toBeDeletedIdentities
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private void deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker)  throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) **************");
        try{
            if(toBeDeletedIdentities!=null){
                Iterator<Identity> iterator =toBeDeletedIdentities.iterator();
                while (iterator.hasNext()){
                    Object toBeDeleted = createObjectFromIdentity(iterator.next(), broker);
                    broker.delete(toBeDeleted);
                }
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.deleteIdentities(Collection<Identity> toBeDeletedIdentities,PersistenceBroker broker) ***************");
    }

    /**
     *
     * @param identity
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Object createObjectFromIdentity(Identity identity,PersistenceBroker broker)  throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) **************");
        if(identity==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) : identity can't be null. ");
        Object objectFromIdentity = null;
        try{
            Class realClass =identity.getObjectsRealClass();
            if(realClass==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) :  objectRealClass of identity can't be null ");
            ClassDescriptor classDescriptor = broker.getClassDescriptor(realClass);
            Object[] primaryKeyValues= identity.getPrimaryKeyValues();
            objectFromIdentity = ClassHelper.newInstance(realClass);
            FieldDescriptor[] pkFields =  classDescriptor.getPkFields();
            for (int index=0; index <pkFields.length; index ++  ){
                PersistentField persistentField = pkFields[index].getPersistentField();
                persistentField.set(objectFromIdentity,primaryKeyValues[index]);
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.createObjectFromIdentity(Identity identity,PersistenceBroker broker) ***************");
        return objectFromIdentity;
    }


    /**
     * This method looks in the database for all the entries linked to the entry relative to <code>parentVO</code> trough
     * the relationship represented by <code>pAttributeName</code>, that must be an attribute of <code>parentVO</code> holding a collection,
     * then the method builds an identity from each entry for which no object representing it exists in the collection held by <code>pAttributeName</code>.</br>
     *
     * @param parentVO
     * @param pAttributeName
     * @param broker
     * @return  A collection of instances of Identity that are referenced by <code>parentVO</code> in the database but have not a correspondent betwee the
     *          elements of the collection <code>parentVO.pAttributeName</code>.</br>
     * @throws it.aco.mandragora.exception.OjbPbCoreException  -If  <code>parentVO</code> is null or <code>pAttributeName</code> is null or empty or blank characters string.</br>
     */
    private Collection<Identity> getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) **************");
        Collection<Identity> notInBeanReferencedIdentities = null;
        try{
            if(parentVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : parentVO can't be null. ");
            if(pAttributeName==null||pAttributeName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank characters string. ");

            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();



            notInBeanReferencedIdentities = getObjectReferencedIdentities( parentVO,  pAttributeName,  broker);

            Collection pAttributeNameCollection = (Collection)  propertyUtilsBean.getProperty(parentVO,pAttributeName);
            if(pAttributeNameCollection!=null &&!notInBeanReferencedIdentities.isEmpty()){//notInBeanReferencedIdentities is never null
                Iterator pAttributeNameCollectionIterator = pAttributeNameCollection.iterator();
                IdentityFactory identityFactory  = broker.serviceIdentity();
                while (pAttributeNameCollectionIterator.hasNext()){

                    Object pAttributeNameItem = pAttributeNameCollectionIterator.next();
                    Identity currentIdentity =  identityFactory.buildIdentity(pAttributeNameItem);
                    log.debug("currentIdentity ="+currentIdentity.toString());
                    Iterator<Identity> notInBeanReferencedIdentitiesIterator = notInBeanReferencedIdentities.iterator();
                    while (notInBeanReferencedIdentitiesIterator.hasNext()){
                        Identity referencedIdentity = notInBeanReferencedIdentitiesIterator.next();
                        log.info("referencedIdentity ="+referencedIdentity.toString());
                        if(referencedIdentity.equals(currentIdentity)){
                            notInBeanReferencedIdentitiesIterator.remove();
                            break;
                        }
                    }
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }catch (IllegalAccessException e) {
            log.error("IllegalAccessException thrown in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException thrown in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }catch (InvocationTargetException e) {
            log.error("InvocationTargetException thrown in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getNotInBeanReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) ***************");
        return notInBeanReferencedIdentities;
    }

    //todo syncronize design
    /**
     *
     * @param parentVO
     * @param pAttributeName
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Collection<Identity> getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) **************");
        Collection<Identity> inBeanNotStoredOrNotReferencedIdentities = new ArrayList<Identity>() ;
        try{
            if(parentVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : parentVO can't be null. ");
            if(pAttributeName==null||pAttributeName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank characters string. ");

            ClassDescriptor classDescriptor = broker.getClassDescriptor(parentVO.getClass());

            ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(pAttributeName);
            if(objectReferenceDescriptor==null) objectReferenceDescriptor = classDescriptor.getCollectionDescriptorByName(pAttributeName);

            //CollectionDescriptor collectionDescriptor = broker.getClassDescriptor(parentVO.getClass()).getCollectionDescriptorByName(pAttributeName);
            //Class itemClass = collectionDescriptor.getItemClass();
            Class itemClass = objectReferenceDescriptor.getItemClass();

            IdentityFactory identityFactory = broker.serviceIdentity();

            Collection<Identity>  objectReferencedIdentities = getObjectReferencedIdentities(parentVO,  pAttributeName,  broker);  // it is never null
            if(CollectionDescriptor.class.isInstance(objectReferenceDescriptor)) {
                Collection pAttributeCollection = (Collection) objectReferenceDescriptor.getPersistentField().get(parentVO);
                if(pAttributeCollection!=null && !pAttributeCollection.isEmpty()){
                    Iterator pAttributeIterator = pAttributeCollection.iterator();
                    while (pAttributeIterator.hasNext()){
                        //Object pAttributeItem = pAttributeIterator.next();
                        Identity pAttributeIdentity  = identityFactory.buildIdentity(pAttributeIterator.next());
                        pAttributeIdentity.setObjectsRealClass(itemClass);
                        if(objectReferencedIdentities!=null){
                            Iterator<Identity> objectReferencedIdentitiesIterator = objectReferencedIdentities.iterator();
                            boolean inBeanNotStoredOrNotReferenced = true;
                            while (objectReferencedIdentitiesIterator.hasNext()){
                                if (pAttributeIdentity.equals(objectReferencedIdentitiesIterator.next())){
                                    inBeanNotStoredOrNotReferenced= false;
                                    break;
                                }
                            }
                            if (inBeanNotStoredOrNotReferenced) inBeanNotStoredOrNotReferencedIdentities.add(pAttributeIdentity);
                        } else {
                            inBeanNotStoredOrNotReferencedIdentities.add(pAttributeIdentity);
                        }
                    }
                }
            } else {
                Object pAttributeValue =  objectReferenceDescriptor.getPersistentField().get(parentVO);
                if(pAttributeValue!=null) {
                    Identity pAttributeIdentity  = identityFactory.buildIdentity(pAttributeValue);
                    pAttributeIdentity.setObjectsRealClass(itemClass);
                    if(objectReferencedIdentities!=null && !objectReferencedIdentities.isEmpty()){
                        if (!pAttributeIdentity.equals(objectReferencedIdentities.iterator().next())){
                            inBeanNotStoredOrNotReferencedIdentities.add(pAttributeIdentity);
                        }
                    }else {
                        inBeanNotStoredOrNotReferencedIdentities.add(pAttributeIdentity);
                    }
                }

            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }/*catch (IllegalAccessException e) {
            log.error("IllegalAccessException thrown in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException thrown in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }catch (InvocationTargetException e) {
            log.error("InvocationTargetException thrown in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }*/ catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getInBeanNotStoredOrNotReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) ***************");
        return inBeanNotStoredOrNotReferencedIdentities;
    }


    /**
     * This method returns a collection of instances of Identity that are relative to the objects (entries) that in the database
     * are referenced by the object represented by <code>identity</code> trough the relationship represented by <code>attributeDescriptor</code> .</br>
     * Note that if the relationship is 1:1 the result collection will hold just one item.</br>
     * If <code>identity</code> is null a null will be returned, while if no referenced element exists in the database an empty collection will be returned.</br>
     * @param identity
     * @param attributeDescriptor
     * @param broker
     * @return A collection of instances of Identity.
     * @throws it.aco.mandragora.exception.OjbPbCoreException - If  <code>attributeDescriptor</code> is null.</br>
     */
    private Collection<Identity> getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) **************");
        Collection<Identity> identityReferencedIdentities =null;
        try{
            if(attributeDescriptor==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) :: attributeDescriptor can't be null. ");

            //PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            //Object object;
            //ArrayList  identityReferencedIdentities = null;
            if(identity != null){
                identityReferencedIdentities = new ArrayList<Identity>();
                Class realClass = identity.getObjectsRealClass();
                if (realClass == null ) throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) : objectRealClass of identity can't be null. ");
                ClassDescriptor classDescriptor = broker.getClassDescriptor(realClass);
                Object[] primaryKeyValues = identity.getPrimaryKeyValues();
                FieldDescriptor[] pkFields = classDescriptor.getPkFields();
                Criteria criteria = new Criteria();

                for (int index=0; index<primaryKeyValues.length;index++){
                    //String attributeName = pkFields[index].getAttributeName();
                    criteria.addEqualTo(pkFields[index].getAttributeName(),primaryKeyValues[index]);
                }
                ReportQueryByCriteria  query = QueryFactory.newReportQuery(realClass, criteria);

                String attributeName = attributeDescriptor.getAttributeName();
                Class itemClass = attributeDescriptor.getItemClass();
                ClassDescriptor itemClassDescriptor = broker.getClassDescriptor(itemClass);
                FieldDescriptor[] itemPkFields =itemClassDescriptor.getPkFields();

                String[] itemPkFieldNames = new String[itemPkFields.length]; // TODO syncronize with design
                String[] itemPathPkFieldNames = new String[itemPkFields.length];
                for (int index = 0; index<itemPkFields.length; index++){
                    itemPkFieldNames[index] = itemPkFields[index].getAttributeName();// TODO syncronize with design
                    itemPathPkFieldNames[index] = attributeName+"."+itemPkFieldNames[index];
                    //itemPathPkFieldNames[index] = attributeName+"."+itemPkFields[index].getAttributeName();

                }
                query.setAttributes(itemPathPkFieldNames);
                Iterator iterator = broker.getReportQueryIteratorByQuery(query);
                IdentityFactory identityFactory = broker.serviceIdentity();

                if(iterator!=null){
                    while (iterator.hasNext()){
                        //Identity currentIdentity =  identityFactory.buildIdentity(itemClass,  itemPathPkFieldNames,(Object[]) iterator.next());
                        Identity currentIdentity =  identityFactory.buildIdentity(itemClass, itemPkFieldNames,(Object[]) iterator.next());// TODO syncronize with design
                        currentIdentity.setObjectsRealClass(itemClass);
                        identityReferencedIdentities.add(currentIdentity);
                    }
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getIdentityReferencedIdentities(Identity identity, ObjectReferenceDescriptor attributeDescriptor, PersistenceBroker broker) ***************");
        return identityReferencedIdentities;
    }

    /**
     *
     * @param identity
     * @param objectReferenceDescriptor
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Identity getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker)  ***************");
        Identity referencedIdentity = null;
        try{
            if(objectReferenceDescriptor==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker)  :: objectReferenceDescriptor can't be null. ");
            if (identity!=null){
                Collection<Identity> identityReferencedIdentities =  getIdentityReferencedIdentities(identity ,objectReferenceDescriptor,broker);
                if(identityReferencedIdentities!= null &&!identityReferencedIdentities.isEmpty()){
                    referencedIdentity =  identityReferencedIdentities.iterator().next() ;
                }
            }

        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        }

        log.info("************Done with the BaseOjbPbCore.getIdentityReferencedIdentity(Identity  identity , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) **************");
        return referencedIdentity;
    }

    /**
     *
     * @param parentVO
     * @param objectReferenceDescriptor
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Identity getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker)  ***************");
        Identity changedChildIdentity = null;
        try{
            if(objectReferenceDescriptor  == null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker)  :: objectReferenceDescriptor can't be null. ");
            if(CollectionDescriptor.class.isInstance(objectReferenceDescriptor)) throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker)   :: objectReferenceDescriptor can't be a CollectionDescriptor. ");
            if(parentVO!=null){
                IdentityFactory identityFactory = broker.serviceIdentity();
                Identity parentIdentity = identityFactory.buildIdentity(parentVO);
                parentIdentity.setObjectsRealClass(parentVO.getClass());
                Identity referencedIdentity = getIdentityReferencedIdentity(parentIdentity, objectReferenceDescriptor, broker);

                if(referencedIdentity!=null){
                    log.debug("getChangedChildIdentity: referencedIdentity = "+referencedIdentity.toString());
                    Object childVO = objectReferenceDescriptor.getPersistentField().get(parentVO);
                    if (childVO!=null){
                        Identity childIdentity = identityFactory.buildIdentity(childVO);
                        childIdentity.setObjectsRealClass(objectReferenceDescriptor.getItemClass());
                        log.debug("getChangedChildIdentity: childIdentity = "+childIdentity.toString());
                        if (!childIdentity.equals(referencedIdentity)) {
                            changedChildIdentity = referencedIdentity ;

                        }
                    }else{ //added by  alessandro on 19-Nov 2008 todo syncronize design
                        log.debug("childVO: is null = ");
                        changedChildIdentity = referencedIdentity ;
                    }
                }

            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) : " + e.toString(),e);
        }

        log.info("************Done with the BaseOjbPbCore.getChangedChildIdentity(Object parentVO , ObjectReferenceDescriptor objectReferenceDescriptor, PersistenceBroker broker) **************");
        return changedChildIdentity;
    }
    /**
     * This method returns a collection of instances of Identity that are relative to the objects (entries) that in the database
     * are referenced by the object represented by <code>parentVO</code> trough the relationship represented by <code>pAttributeName</code>,
     * that must be an attribute of <code>parentVO</code>.</br>
     * Note that if the relationship is 1:1 the result collection will hold just one item.</br>
     * If no referenced element exists in the database an empty collection will be returned.</br>
     * A null is never returned
     * @param parentVO
     * @param pAttributeName
     * @param broker
     * @return   A collection of instances of Identity
     * @throws it.aco.mandragora.exception.OjbPbCoreException  -If  <code>parentVO</code> is null or <code>pAttributeName</code> is null or empty or blank characters string.</br>
     */
    private Collection<Identity> getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) **************");
        Collection<Identity> objectReferencedIdentities =null; // note that null is never returned because getIdentityReferencedIdentities(identity, objectReferenceDescriptor, broker); //
                                                     // return null just if identity is null.
        try{
            if(parentVO ==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : parentVO can't be null. ");
            if(pAttributeName==null||pAttributeName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : pAttributeName can't be null or empty or blank characters string. ");

            IdentityFactory identityFactory = broker.serviceIdentity();
            Identity identity = identityFactory.buildIdentity(parentVO);

            Class realClass= parentVO.getClass();
            identity.setObjectsRealClass(realClass);

            ClassDescriptor classDescriptor = broker.getClassDescriptor(realClass);

            ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(pAttributeName);
            if(objectReferenceDescriptor == null) objectReferenceDescriptor= classDescriptor.getCollectionDescriptorByName(pAttributeName);
            //log.debug("realClass :: "+realClass.getName());
            //log.debug("pAttributeName :: "+pAttributeName);
            //log.debug("objectReferenceDescriptor :: "+objectReferenceDescriptor.toString());
            objectReferencedIdentities = getIdentityReferencedIdentities(identity, objectReferenceDescriptor, broker);


        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getObjectReferencedIdentities(Object parentVO, String pAttributeName, PersistenceBroker broker) ***************");
        return objectReferencedIdentities;
    }


    public Object store(Object storeVO,ObjectModification modification, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker)***************");
        if(storeVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): storeVO can't be null. ");
        try{
                broker.store(storeVO,modification);
        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): " + e.toString(),e);
        }catch (Exception e) {
            throw new OjbPbCoreException("Error in BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.store(Object storeVO,ObjectModification modification, PersistenceBroker broker)***************");
        return storeVO;
    }

    public void storeCollection(Collection storeVOs, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker) ***************");
        if(storeVOs==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): storeVOs can't be null. ");
        try{
            Iterator iterator = storeVOs.iterator();
            while (iterator.hasNext()) {
                broker.store(iterator.next());
            }
        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.storeCollection(Collection storeVOs, PersistenceBroker broker)***************");
    }


    /**
     * Update the table entry  associated to <code>storeVO</code> and all records of the table associated to <code>pAttributeName</code>.
     * <code>pAttributeName<(code> has to be the name of a collection properties.
     * </br>
     * This methods deletes the records of the table associated to the attribute <code>pAttributeName</code> of the class of <code>storeVO</code> that can't be found
     *  between the elements held by the the collection represented by the same <code>pAttributeName</code>
     * @param storeVO
     * @param pAttributeName
     * @param broker PersistenceBroker instance that performs the operation
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    public Object updateCollectionReference(Object storeVO, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker)***************");
        if(storeVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): storeVO can't be null. ");

        try{

            CollectionDescriptor collectionDescriptor = broker.getClassDescriptor(storeVO.getClass()).getCollectionDescriptorByName(pAttributeName);
            int cascadingStore = collectionDescriptor.getCascadingStore();
            if (cascadingStore == ObjectReferenceDescriptor.CASCADE_OBJECT){
                broker.store(storeVO);
                if(!collectionDescriptor.isMtoNRelation()) {
                    // just delete the not in bean referenced objects
                    updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.FALSE, Boolean.FALSE, Boolean.TRUE, broker) ;
                } // if it is M2N deletion is performed by the broker.store
            }else if(cascadingStore == ObjectReferenceDescriptor.CASCADE_LINK){
                if(!collectionDescriptor.isMtoNRelation()) {
                    broker.store(storeVO);
                    updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE, Boolean.FALSE, Boolean.TRUE, broker) ;
                }else {  // is M2N
                    updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE,Boolean.FALSE, Boolean.TRUE, broker) ;
                    broker.store(storeVO);
                }
            } else if(cascadingStore == ObjectReferenceDescriptor.CASCADE_NONE){
                broker.store(storeVO);
                updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE,Boolean.TRUE, Boolean.TRUE,  broker) ;
            }


            //broker.store(storeVO);
            //storeVO = updateCollectionReferenceWithoutMain(storeVO,pAttributeName, broker);

        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.updateCollectionReference(Object storeVO, java.lang.String pAttributeName, PersistenceBroker broker)***************");
        return storeVO;
    }

    /*TODO updateCollectionReference(Object storeVO, String pAttributeName, PersistenceBroker broker, Boolean ifM2NDeleteOnlyRelationship)*/

    /**
     *  TODO change in the design
     * @param storeVO
     * @param pAttributeName
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    private Object updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) **************");
        if(storeVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) : storeVO can't be null. ");
        if(pAttributeName==null||pAttributeName.trim().equals("")) throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker)  : pAttributeName can't be null or empty or blank characters string. ");
        try{
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();

            if(deleteNotInBeanReferencedObjects.booleanValue())  {
                Collection notInBeanReferencedIdentities= getNotInBeanReferencedIdentities(storeVO,pAttributeName,broker)  ;

                if(notInBeanReferencedIdentities==null){
                    log.debug("notInBeanReferencedIdentities == null");
                } else{
                    log.debug("notInBeanReferencedIdentities.size() = "+notInBeanReferencedIdentities.size() );
                }
                //deleteReferencedIdentitiesCollection(storeVO,pAttributeName,notInBeanReferencedIdentities,broker,Boolean.TRUE);
                deleteReferencedIdentitiesCollection(storeVO,pAttributeName,notInBeanReferencedIdentities,broker,ifM2NDeleteOnlyRelationship);
            }

            Collection pAttributeNameCollection = (Collection) propertyUtilsBean.getProperty(storeVO, pAttributeName);

            if(pAttributeNameCollection!=null ){

                if(storeCollection.booleanValue())  {
                    CollectionDescriptor collectionDescriptor = broker.getClassDescriptor(storeVO.getClass()).getCollectionDescriptorByName(pAttributeName);
                    if(!collectionDescriptor.isMtoNRelation()){
                        setInverseForeignKeyFields(storeVO, pAttributeName, broker);
                    }
                    storeCollection(pAttributeNameCollection,broker);
                }

                if(linkCollection.booleanValue()){
                    BrokerHelper brokerHelper = broker.serviceBrokerHelper();
                    Collection inBeanNotStoredOrNotReferencedIdentities = getInBeanNotStoredOrNotReferencedIdentities(storeVO, pAttributeName, broker);
                    if (inBeanNotStoredOrNotReferencedIdentities!=null){
                        Iterator iterator = inBeanNotStoredOrNotReferencedIdentities.iterator();
                        while(iterator.hasNext()) {
                            Object  reference = createObjectFromIdentity((Identity)iterator.next(),broker);
                            brokerHelper.link(storeVO,pAttributeName,reference,false);
                       }
                    }
                }
            }

        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) : " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) : " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.updateCollectionReferenceWithoutMain(Object storeVO, String pAttributeName, Boolean deleteNotInBeanReferencedObjects, Boolean storeCollection, Boolean linkCollection, Boolean ifM2NDeleteOnlyRelationship, PersistenceBroker broker) ***************");
        return storeVO;
    }



    public Object updateCollectionReferences(Object storeVO, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker)***************");
        if(storeVO==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): storeVO can't be null. ");

        try{
            ClassDescriptor storeVOClassDescriptor = broker.getClassDescriptor(storeVO.getClass());
            Collection collectionDescriptors = storeVOClassDescriptor.getCollectionDescriptors();

            if(collectionDescriptors!=null){
                Iterator  iterator = collectionDescriptors.iterator();
                while (iterator.hasNext()) {
                    CollectionDescriptor collectionDescriptor = (CollectionDescriptor)iterator.next();
                    if(collectionDescriptor.getCascadingStore() == ObjectReferenceDescriptor.CASCADE_LINK && collectionDescriptor.isMtoNRelation()) {
                        String pAttributeName = collectionDescriptor.getPersistentField().getName();
                        updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE, Boolean.FALSE, Boolean.TRUE, broker) ;
                    }
                }
                broker.store(storeVO);
                iterator = collectionDescriptors.iterator();
                while (iterator.hasNext()) {
                    CollectionDescriptor collectionDescriptor = (CollectionDescriptor)iterator.next();
                    int cascadingStore = collectionDescriptor.getCascadingStore();
                    String pAttributeName = collectionDescriptor.getPersistentField().getName();


                    if (cascadingStore == ObjectReferenceDescriptor.CASCADE_OBJECT){
                        if(!collectionDescriptor.isMtoNRelation()) {
                            // just delete the not in bean referenced objects
                            updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.FALSE, Boolean.FALSE, Boolean.TRUE, broker) ;
                        } // if it is M2N deletion is performed by the broker.store
                    }else if(cascadingStore == ObjectReferenceDescriptor.CASCADE_LINK){
                        if(!collectionDescriptor.isMtoNRelation()) {
                            updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE, Boolean.FALSE, Boolean.TRUE, broker) ;
                        }
                    } else if(cascadingStore == ObjectReferenceDescriptor.CASCADE_NONE){
                        updateCollectionReferenceWithoutMain(storeVO, pAttributeName, Boolean.TRUE, Boolean.TRUE,Boolean.TRUE, Boolean.TRUE,  broker) ;
                    }
                }
            }


        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.updateCollectionReferences(Object storeVO, PersistenceBroker broker)***************");
        return storeVO;
    }

    /**
     *
     * @param rootVO
     * @param path
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Collection<IdentityPath> getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker)  throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker)  ***************");
        ArrayList<IdentityPath> changedDirectReferencesInPath = new ArrayList<IdentityPath>();
        try{
            if (rootVO!=null&&path!=null && !path.trim().equals("")){
                ClassDescriptor classDescriptor = broker.getClassDescriptor(rootVO.getClass());
                String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                String firstAttributeName = firstAttributeNameAndRemainingPath[0];
                String remainingPath = firstAttributeNameAndRemainingPath[1];

                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();

                Object firstAttributeValue = propertyUtilsBean.getProperty(rootVO,firstAttributeName);
                //if(firstAttributeValue!=null){ // deleted by ale 19-nov 2008 todo syncornize design
                    ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                    if(objectReferenceDescriptor==null) objectReferenceDescriptor = classDescriptor.getCollectionDescriptorByName(firstAttributeName);  // added by alessandro on 12-nov 2008 todo syncronize design
                    if (CollectionDescriptor.class.isInstance(objectReferenceDescriptor)){
                        if(firstAttributeValue!=null){ // only condition added by ale 19-nov 2008 todo syncornize design
                            Iterator iterator =  ((Collection)firstAttributeValue).iterator();
                            while (iterator.hasNext()){
                                Collection<IdentityPath> partialChangedDirectReferencesInPath = getChangedDirectReferencesInPath(iterator.next(), remainingPath, broker);
                                if(partialChangedDirectReferencesInPath!=null ) changedDirectReferencesInPath.addAll(partialChangedDirectReferencesInPath);
                            }
                        }
                    } else{ // direct relationship 1:1
                        Identity changedChildIdentity = getChangedChildIdentity(rootVO, objectReferenceDescriptor, broker);
                        if(changedChildIdentity!=null){
                            IdentityPath identityPath = new IdentityPath(changedChildIdentity,remainingPath);
                            changedDirectReferencesInPath.add(identityPath);
                        }
                        if(firstAttributeValue!=null){ // condition added by ale 19-nov 2008 todo syncornize design
                            Collection<IdentityPath> partialChangedDirectReferencesInPath = getChangedDirectReferencesInPath(firstAttributeValue, remainingPath, broker);
                            if(partialChangedDirectReferencesInPath!=null ) changedDirectReferencesInPath.addAll(partialChangedDirectReferencesInPath);
                        }

                    }
                //}
            }
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getChangedDirectReferencesInPath(Object rootVO, String path, PersistenceBroker broker)**************");
        return changedDirectReferencesInPath;

    }
    /**
     *
     * @param rootVO
     * @param paths
     * @param pathsHasToBeSorted
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private Collection<IdentityPaths> getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker)  throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker) ***************");
        ArrayList<IdentityPaths> changedDirectReferencesInPaths = new ArrayList<IdentityPaths>();
        try{
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            if(rootVO != null && paths!=null &&!paths.isEmpty() ){
                Class rootVOClass = rootVO.getClass();
                String[] pathsArray = new String[paths.size()];
                if(pathsHasToBeSorted.booleanValue()){
                    ArrayList<String> pathsList = Collections.list(Collections.enumeration(paths));
                    Collections.sort(pathsList);
                    pathsArray = (String[])pathsList.toArray(pathsArray);
                } else{
                    pathsArray = (String[])paths.toArray(pathsArray);
                }
                int pathsArrayLenght = pathsArray.length;
                int index = 0;
                while (index<pathsArrayLenght){
                    String path = pathsArray[index];
                    if(path!=null && !path.trim().equals("")){
                        String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                        String firstAttributeName = firstAttributeNameAndRemainingPath[0];
                        String remainingPath = firstAttributeNameAndRemainingPath[1];
                        ArrayList<String> subPaths = new ArrayList<String>();
                        if(!remainingPath.trim().equals(""))subPaths.add(remainingPath);
                        index++;
                        boolean matchingFirstAttributeName = true;
                        while(index < pathsArrayLenght  && matchingFirstAttributeName){
                            if(pathsArray[index]!=null && !pathsArray[index].trim().equals("")){
                                String[] firstAttributeNameAndRemainingPath2 = Utils.getFirstAttributeNameAndRemainingPath(pathsArray[index]);
                                String firstAttributeName2 = firstAttributeNameAndRemainingPath2[0];
                                if(firstAttributeName2.equals(firstAttributeName)){
                                    if(!firstAttributeNameAndRemainingPath2[1].trim().equals(""))subPaths.add(firstAttributeNameAndRemainingPath2[1]);
                                    index++;
                                }else{
                                    matchingFirstAttributeName = false;
                                }
                            } else{
                                index++;
                            }
                        }

                        if(subPaths.size()<=1){
                            Collection<IdentityPath> changedDirectReferencesInPathIdentityPathCollection = getChangedDirectReferencesInPath(rootVO, path, broker);
                            if (changedDirectReferencesInPathIdentityPathCollection!=null){
                                Iterator<IdentityPath> iterator = changedDirectReferencesInPathIdentityPathCollection.iterator();
                                while(iterator.hasNext()){
                                    changedDirectReferencesInPaths.add(new IdentityPaths(iterator.next()));
                                }
                            }
                        }else{// subPaths.size() >1

                            ClassDescriptor classDescriptor =   broker.getClassDescriptor(rootVOClass);
                            Object firstAttributeValue = propertyUtilsBean.getProperty(rootVO,firstAttributeName);
                            ObjectReferenceDescriptor objectReferenceDescriptor = classDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                            if(objectReferenceDescriptor==null) objectReferenceDescriptor =classDescriptor.getCollectionDescriptorByName(firstAttributeName); // todo syncronize design uml
                            if(CollectionDescriptor.class.isInstance(objectReferenceDescriptor)){
                                if(firstAttributeValue!=null){
                                    Iterator iterator = ((Collection)firstAttributeValue).iterator();
                                    while (iterator.hasNext()){
                                        Collection<IdentityPaths>  partialChangedDirectReferencesInPaths = getChangedDirectReferencesInPaths(iterator.next(), subPaths, Boolean.FALSE, broker);
                                        if(partialChangedDirectReferencesInPaths!=null) changedDirectReferencesInPaths.addAll(partialChangedDirectReferencesInPaths);

                                    }
                                }
                            } else {  // firstAttributeValue is not a collection
                                Identity changedChildIdentity = getChangedChildIdentity(rootVO, objectReferenceDescriptor,broker);
                                if(changedChildIdentity!=null)  {
                                    IdentityPaths identityPaths = new IdentityPaths(changedChildIdentity,subPaths);
                                    changedDirectReferencesInPaths.add(identityPaths);
                                }
                                Collection<IdentityPaths> partialChangedDirectReferencesInPaths = getChangedDirectReferencesInPaths(firstAttributeValue, subPaths, Boolean.FALSE, broker);
                                if(partialChangedDirectReferencesInPaths!=null)  changedDirectReferencesInPaths.addAll(partialChangedDirectReferencesInPaths);
                            }
                        }
                    } else{
                        index++;
                    }
                }


            }
        }catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getChangedDirectReferencesInPaths (Object rootVO, Collection<String> paths, Boolean pathsHasToBeSorted, PersistenceBroker broker)***************");
        return changedDirectReferencesInPaths;
    }

    /**
     *
     * @param storeVOs
     * @param attributeDescriptorsForPath
     * @param startIndex
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    private void storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,   PersistenceBroker broker) ***************");

        try{
            log.debug("startIndex = " +startIndex);
            if (startIndex<0) throw new OjbPbCoreException("in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,   PersistenceBroker broker) : Error: startIndex<0 ");
            if (storeVOs==null) {
                log.debug("storeVOs==null");
            }else{
                log.debug("storeVOs.size() == "+ storeVOs.size());
            }



            if (storeVOs!=null && !storeVOs.isEmpty()){
                int endIndex = attributeDescriptorsForPath.size()-1;
                if(attributeDescriptorsForPath== null || attributeDescriptorsForPath.isEmpty() ||startIndex>endIndex){
                    storeCollection(storeVOs,broker);
                } else {

                    //if (startIndex>endIndex) throw new OjbPbCoreException("in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,  PersistenceBroker broker) : Error: startIndex>endIndex ");


                    int index = startIndex;
                    String path="";

                    while(index<=endIndex && ((ObjectReferenceDescriptor)attributeDescriptorsForPath.get(index)).getCascadingStore()==ObjectReferenceDescriptor.CASCADE_OBJECT){
                        String attributeDescriptorName = ((ObjectReferenceDescriptor)attributeDescriptorsForPath.get(index)).getAttributeName();
                        if (path.trim().equals("")){
                            path = attributeDescriptorName;
                        }else{
                            path = path+"."+attributeDescriptorName;
                        }
                        index++;
                    }
                    if(index>endIndex){
                        storeCollection(storeVOs,broker);
                        return;
                    }

                    // NOT CASCADE_OBJECT

                    BrokerHelper brokerHelper = broker.serviceBrokerHelper();

                    //startIndex = index + 1;
                    log.debug ("index = "+index);
                    AttributeDescriptorBase attributeDescriptorBase = (AttributeDescriptorBase) attributeDescriptorsForPath.get(index);
                    String attributeName = attributeDescriptorBase.getAttributeName();
                    if (!CollectionDescriptor.class.isInstance(attributeDescriptorBase)) { // is ObjectReferenceDescriptor
                        Collection parentVOs = BeanCollectionUtils.getTreeLeaves(storeVOs,path);
                        Collection childrenVOs = BeanCollectionUtils.getTreeLeaves(parentVOs,attributeName);
                        log.debug("parentVOs == null is "+parentVOs == null) ;
                        log.debug("path == "+path);
                        log.debug("attributeName == "+attributeName);
                        //storeCollectionCascadeByAttributeDescriptorsForPath(childrenVOs, attributeDescriptorsForPath,startIndex,broker);

                        storeCollectionCascadeByAttributeDescriptorsForPath(childrenVOs, attributeDescriptorsForPath,index+1,broker);
                        //start added by Alessandro On Nov the 3rd 2008   TODO change on design
                        if(((ObjectReferenceDescriptor)attributeDescriptorBase).getCascadingStore()!=ObjectReferenceDescriptor.CASCADE_LINK){
                            if (parentVOs!=null){
                                Iterator iterator = parentVOs.iterator();
                                while (iterator.hasNext()){
                                     setForeignKeyFields(iterator.next(),attributeName,broker);
                                }
                            }
                        }
                        // end added by Alessandro On Nov the 3rd 2008
                        storeCollection(storeVOs, broker);
                        /* deleted by Alessandro On Nov the 3rd 2008    TODO change on design
                        if(((ObjectReferenceDescriptor)attributeDescriptorBase).getCascadingStore()!=ObjectReferenceDescriptor.CASCADE_LINK){
                            if (parentVOs!=null){
                                Iterator iterator = parentVOs.iterator();
                                ObjectReferenceDescriptor objectReferenceDescriptor = (ObjectReferenceDescriptor) attributeDescriptorBase;
                                while (iterator.hasNext()){
                                    brokerHelper.link(iterator.next(), objectReferenceDescriptor , false)  ;
                                }
                            }
                        }
                        */
                    }else{     //Both cases of 1ToN and Not M2N
                        CollectionDescriptor collectionDescriptor = (CollectionDescriptor) attributeDescriptorBase;
                        Collection parentVOs = BeanCollectionUtils.getTreeLeaves(storeVOs,path);
                        if(parentVOs==null || parentVOs.isEmpty() || !collectionDescriptor.isMtoNRelation() || collectionDescriptor.getCascadingStore()!= ObjectReferenceDescriptor.CASCADE_LINK){
                            storeCollection(storeVOs,broker);
                        }

                        if(parentVOs!=null && ! parentVOs.isEmpty()){
                            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                            Iterator iterator = parentVOs.iterator();
                            while (iterator.hasNext()){
                                Object parentVO = iterator.next();

                                //start added by Alessandro On Nov the 3rd 2008   TODO change on design
                                if(!collectionDescriptor.isMtoNRelation()){
                                    setInverseForeignKeyFields(parentVO, attributeName,broker);
                                }
                                //end added by Alessandro On Nov the 3rd 2008
                                Collection nextStoreVOs = (Collection)propertyUtilsBean.getProperty(parentVO, attributeName);
                                //storeCollectionCascadeByAttributeDescriptorsForPath(nextStoreVOs, attributeDescriptorsForPath, startIndex, broker );
                                storeCollectionCascadeByAttributeDescriptorsForPath(nextStoreVOs, attributeDescriptorsForPath, index+1, broker );
                                //if(!collectionDescriptor.isMtoNRelation() || collectionDescriptor.getCascadingStore()!= ObjectReferenceDescriptor.CASCADE_LINK){ // condition changed on Nov the 3rd 2008
                                if(collectionDescriptor.isMtoNRelation() && collectionDescriptor.getCascadingStore()!= ObjectReferenceDescriptor.CASCADE_LINK){ // todo change the condition in the design too
                                    // start added by alessandro 06/11/2008

                                    Collection inBeanNotStoredOrNotReferencedIdentities = getInBeanNotStoredOrNotReferencedIdentities(parentVO, attributeName, broker); // sure are not referenced as nextStoreVOs as already been stored
                                    if (inBeanNotStoredOrNotReferencedIdentities!=null){
                                        Iterator iterator2 = inBeanNotStoredOrNotReferencedIdentities.iterator();
                                        while(iterator2.hasNext()) {
                                            Object  reference = createObjectFromIdentity((Identity)iterator2.next(),broker);
                                            brokerHelper.link(parentVO, collectionDescriptor, reference);
                                            //brokerHelper.link(storeVO,pAttributeName,reference,false);
                                       }
                                    }

                                    // end added by alessandro 06/11/2008
                                    /* deleted  by alessandro 06/11/2008
                                    if(nextStoreVOs!=null){
                                        Iterator nextStoreVOsIterator = nextStoreVOs.iterator();
                                        while (nextStoreVOsIterator.hasNext()){
                                            brokerHelper.link(parentVO, collectionDescriptor, nextStoreVOsIterator.next());
                                        }
                                    }
                                    */
                                }
                            }
                            if(collectionDescriptor.isMtoNRelation()&&collectionDescriptor.getCascadingStore()== ObjectReferenceDescriptor.CASCADE_LINK){
                                storeCollection(storeVOs,broker);
                            }
                        }
                        /*
                        if(parentVOs==null || parentVOs.isEmpty() ||(collectionDescriptor.isMtoNRelation()&&collectionDescriptor.getCascadingStore()== ObjectReferenceDescriptor.CASCADE_LINK)){
                            storeCollection(storeVOs,broker);
                        }
                        */
                    }
                }

            }
        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,   PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,   PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,  PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,  PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,   PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.storeCollectionCascadeByAttributeDescriptorsForPath(Collection storeVOs, ArrayList attributeDescriptorsForPath, int startIndex,  PersistenceBroker broker)***************");

    }



    public void storePathCascade(Object storeVO, String path,  PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker) ***************");

        try{
            if (storeVO!=null){
                if (path == null || path.trim().equals("")){
                    broker.store(storeVO);
                } else{
                    ArrayList attributeDescriptorsForPath = broker.getClassDescriptor(storeVO.getClass()).getAttributeDescriptorsForPath(path);
                    ArrayList storeVOs =new ArrayList();
                    storeVOs.add(storeVO);
                    storeCollectionCascadeByAttributeDescriptorsForPath(storeVOs, attributeDescriptorsForPath,  0, broker);
                }

            }

        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.storePathCascade(Object storeVO, String path,  PersistenceBroker broker)***************");

    }

    public void storePathsCascade(Object storeVO, Collection paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.storePathsCascade(Object storeVO, Collection paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  PersistenceBroker broker) ***************");
        storePathsCascade( storeVO,  paths,  pathsHasToBeSorted,   storeVOHasToBeStored,  true, broker);
        log.info("************Done with the BaseOjbPbCore.storePathsCascade(Object storeVO, Collection paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  PersistenceBroker broker)***************");
    }


    // todo syncronize design uml
    private  ArrayList<ValueObjectToLinkAndStoreMap> storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored, boolean storeVOIsRoot, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored, boolean storeVOIsRoot,  PersistenceBroker broker) ***************");
        //ArrayList<Object[]> valueObjectToLinkAndStoreMaps = new ArrayList<Object[]>();
        ArrayList<ValueObjectToLinkAndStoreMap> valueObjectToLinkAndStoreMaps = new ArrayList<ValueObjectToLinkAndStoreMap>();
        try{
            if(storeVO!=null){
                if(pathsHasToBeSorted==null)pathsHasToBeSorted= Boolean.TRUE;
                if(storeVOHasToBeStored==null)storeVOHasToBeStored= Boolean.TRUE;
                if(paths!=null && !paths.isEmpty()){
                    PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();

                    HashMap<String,ArrayList<String>> directReferenceNoneCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> directReferenceLinkCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> directReferenceObjectCascadingStoreMap = new HashMap<String,ArrayList<String>>();

                    HashMap<String,ArrayList<String>> oneToNReferenceNoneCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> oneToNReferenceLinkCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> oneToNReferenceObjectCascadingStoreMap = new HashMap<String,ArrayList<String>>();

                    HashMap<String,ArrayList<String>> mToNReferenceNoneCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> mToNReferenceLinkCascadingStoreMap = new HashMap<String,ArrayList<String>>();
                    HashMap<String,ArrayList<String>> mToNReferenceObjectCascadingStoreMap = new HashMap<String,ArrayList<String>>();

                    ClassDescriptor storeVOClassDescriptor = broker.getClassDescriptor(storeVO.getClass());

                    //ArrayList sortedPaths = null;
                    Collection<String> sortedPaths = null;
                    if(pathsHasToBeSorted.booleanValue()){
                        ArrayList<String> tempPaths = Collections.list(Collections.enumeration(paths));
                        Collections.sort(tempPaths);
                        sortedPaths = tempPaths;
                    }  else{
                        sortedPaths = paths;
                    }// no side effects on paths

                    String firstAttributeName="";
                    ArrayList<String> subPaths = null;
                    Iterator iterator = sortedPaths.iterator();  //sure  sortedPaths!=null
                    while(iterator.hasNext()){
                        //log.debug("storePathsCascade : entering in the iterator ");
                        String path = (String) iterator.next();
                        if(path!=null && !path.trim().equals("")){
                            String[] firstAttributeNameAndRemainingPath = Utils.getFirstAttributeNameAndRemainingPath(path);
                            String firstAttributeName2 = firstAttributeNameAndRemainingPath[0];
                            if(!firstAttributeName.equals(firstAttributeName2)){
                                firstAttributeName=firstAttributeName2;
                                //log.debug("storePathsCascade : in iterator firstAttributeName= "+firstAttributeName);

                                ObjectReferenceDescriptor firstAttributeDescriptor =  storeVOClassDescriptor.getObjectReferenceDescriptorByName(firstAttributeName);
                                if(firstAttributeDescriptor==null)firstAttributeDescriptor = storeVOClassDescriptor.getCollectionDescriptorByName(firstAttributeName); // todo make the change in the design
                                if(firstAttributeDescriptor==null) throw new OjbPbCoreException("Error in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored, PersistenceBroker broker) : attribute "+firstAttributeName+" must be a reference 1To1, 1ToN or MtoN");
                                int cascadingStore = firstAttributeDescriptor.getCascadingStore();
                                int relationType = ONE_TO_ONE;
                                if(CollectionDescriptor.class.isInstance(firstAttributeDescriptor)){
                                    if(((CollectionDescriptor)firstAttributeDescriptor).isMtoNRelation()){
                                        relationType = M_TO_N;
                                    }else{
                                        relationType = ONE_TO_N;
                                    }
                                }
                                log.debug("storePathsCascade : in iterator before HashMap map instantiation; relationType= "+relationType);
                                log.debug("storePathsCascade : in iterator before HashMap map instantiation; cascadingStore= "+cascadingStore);
                                HashMap<String,ArrayList<String>> map = null;
                                switch (cascadingStore){
                                    case ObjectReferenceDescriptor.CASCADE_OBJECT:
                                        switch (relationType){
                                            case ONE_TO_ONE: map = directReferenceObjectCascadingStoreMap; break;
                                            case ONE_TO_N: map = oneToNReferenceObjectCascadingStoreMap;break;
                                            case M_TO_N: map = mToNReferenceObjectCascadingStoreMap;break;
                                        };break;
                                    case ObjectReferenceDescriptor.CASCADE_LINK:
                                        switch (relationType){
                                            case ONE_TO_ONE: map = directReferenceLinkCascadingStoreMap; break;
                                            case ONE_TO_N: map = oneToNReferenceLinkCascadingStoreMap;break;
                                            case M_TO_N: map = mToNReferenceLinkCascadingStoreMap;break;
                                        };break;
                                    case ObjectReferenceDescriptor.CASCADE_NONE:
                                        switch (relationType){
                                            case ONE_TO_ONE: map = directReferenceNoneCascadingStoreMap; break;
                                            case ONE_TO_N: map = oneToNReferenceNoneCascadingStoreMap;break;
                                            case M_TO_N: map = mToNReferenceNoneCascadingStoreMap;break;
                                        };break;
                                }
                                //log.debug("storePathsCascade : in iterator before map.put(firstAttributeName, new ArrayList()); ");
                                map.put(firstAttributeName, new ArrayList<String>());   // each key firstAttributeName inserted has always an arraylist at least empty , never nul
                                subPaths = map.get(firstAttributeName);
                            }
                            String remainingPath = firstAttributeNameAndRemainingPath[1];
                            if(remainingPath != null && !remainingPath.trim().equals("")){
                                subPaths.add(remainingPath);
                            }
                        }
                    }



                    iterator = directReferenceNoneCascadingStoreMap.keySet().iterator();
                    String  directReferenceNoneCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        directReferenceNoneCascadingStoreFirstAttributeName = (String) iterator.next();
                        log.debug("storePathsCascade : directReferenceNoneCascadingStoreFirstAttributeName = "+ directReferenceNoneCascadingStoreFirstAttributeName);
                        //storePathsCascade(propertyUtilsBean.getProperty(storeVO, directReferenceNoneCascadingStoreFirstAttributeName),(Collection) directReferenceNoneCascadingStoreMap.get(directReferenceNoneCascadingStoreFirstAttributeName), Boolean.FALSE, Boolean.TRUE, false,broker);
                        valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(propertyUtilsBean.getProperty(storeVO, directReferenceNoneCascadingStoreFirstAttributeName), directReferenceNoneCascadingStoreMap.get(directReferenceNoneCascadingStoreFirstAttributeName), Boolean.FALSE, Boolean.TRUE, false,broker));
                        setForeignKeyFields(storeVO,directReferenceNoneCascadingStoreFirstAttributeName,broker); //added by Alessandro on Nov the 8th 2008 todo syncronize design
                        log.debug("storePathsCascade : directReferenceNoneCascadingStoreFirstAttributeName: storeVO = "+ storeVO.toString());

                    }

                    iterator = directReferenceLinkCascadingStoreMap.keySet().iterator();
                    String  directReferenceLinkCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        directReferenceLinkCascadingStoreFirstAttributeName = (String) iterator.next();
                        valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(propertyUtilsBean.getProperty(storeVO, directReferenceLinkCascadingStoreFirstAttributeName),directReferenceLinkCascadingStoreMap.get(directReferenceLinkCascadingStoreFirstAttributeName), Boolean.FALSE, Boolean.TRUE,false, broker));
                        setForeignKeyFields(storeVO, directReferenceLinkCascadingStoreFirstAttributeName,broker);//added by Alessandro on Nov the 8th 2008 todo syncronize design
                    }

                    iterator = directReferenceObjectCascadingStoreMap.keySet().iterator();
                    String  directReferenceObjectCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        directReferenceObjectCascadingStoreFirstAttributeName = (String) iterator.next();
                        valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(propertyUtilsBean.getProperty(storeVO, directReferenceObjectCascadingStoreFirstAttributeName), directReferenceObjectCascadingStoreMap.get(directReferenceObjectCascadingStoreFirstAttributeName), Boolean.FALSE, new Boolean(!storeVOHasToBeStored.booleanValue()&&storeVOIsRoot), false, broker));//added by Alessandro on Nov the 8th 2008 todo syncronize design
                        //storePathsCascade(propertyUtilsBean.getProperty(storeVO, directReferenceObjectCascadingStoreFirstAttributeName),(Collection) directReferenceObjectCascadingStoreMap.get(directReferenceObjectCascadingStoreFirstAttributeName), Boolean.FALSE, new Boolean(!storeVOHasToBeStored.booleanValue()), broker);//deleted by Alessandro on Nov the 8th 2008 todo syncronize design
                        //setForeignKeyFields(storeVO, directReferenceObjectCascadingStoreFirstAttributeName, broker);    //added by Alessandro on Nov the 8th 2008 todo syncronize design
                    }

                    iterator = mToNReferenceNoneCascadingStoreMap.keySet().iterator();
                    String  mToNReferenceNoneCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        mToNReferenceNoneCascadingStoreFirstAttributeName = (String) iterator.next();
                        Collection mToNReferenceNoneCascadingStoreFirstAttributeValue = (Collection)propertyUtilsBean.getProperty(storeVO, mToNReferenceNoneCascadingStoreFirstAttributeName);
                        if(mToNReferenceNoneCascadingStoreFirstAttributeValue!=null){
                            ArrayList<String>  mToNReferenceNoneCascadingStoreSubPaths = mToNReferenceNoneCascadingStoreMap.get(mToNReferenceNoneCascadingStoreFirstAttributeName);
                            Iterator iterator2 = mToNReferenceNoneCascadingStoreFirstAttributeValue.iterator();
                            while(iterator2.hasNext()){
                                valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(iterator2.next(), mToNReferenceNoneCascadingStoreSubPaths, Boolean.FALSE, Boolean.TRUE,false,broker));
                            }
                        }
                    }

                    iterator = mToNReferenceLinkCascadingStoreMap.keySet().iterator();
                    String  mToNReferenceLinkCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        mToNReferenceLinkCascadingStoreFirstAttributeName = (String) iterator.next();
                        Collection mToNReferenceLinkCascadingStoreFirstAttributeValue = (Collection)propertyUtilsBean.getProperty(storeVO, mToNReferenceLinkCascadingStoreFirstAttributeName);
                        if(mToNReferenceLinkCascadingStoreFirstAttributeValue!=null){
                            ArrayList<String>   mToNReferenceLinkCascadingStoreSubPaths = mToNReferenceLinkCascadingStoreMap.get(mToNReferenceLinkCascadingStoreFirstAttributeName);
                            Iterator iterator2 = mToNReferenceLinkCascadingStoreFirstAttributeValue.iterator();
                            while(iterator2.hasNext()){
                                valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(iterator2.next(), mToNReferenceLinkCascadingStoreSubPaths, Boolean.FALSE, Boolean.TRUE,false,broker));
                            }
                        }
                    }

                    iterator = mToNReferenceObjectCascadingStoreMap.keySet().iterator();
                    String  mToNReferenceObjectCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                       mToNReferenceObjectCascadingStoreFirstAttributeName = (String) iterator.next();
                        Collection mToNReferenceObjectCascadingStoreFirstAttributeValue = (Collection)propertyUtilsBean.getProperty(storeVO, mToNReferenceObjectCascadingStoreFirstAttributeName);
                        if(mToNReferenceObjectCascadingStoreFirstAttributeValue!=null){
                            ArrayList<String>   mToNReferenceObjectCascadingStoreSubPaths = mToNReferenceObjectCascadingStoreMap.get(mToNReferenceObjectCascadingStoreFirstAttributeName);
                            Iterator iterator2 = mToNReferenceObjectCascadingStoreFirstAttributeValue.iterator();
                            while(iterator2.hasNext()){
                                valueObjectToLinkAndStoreMaps.addAll(storePathsCascade(iterator2.next(), mToNReferenceObjectCascadingStoreSubPaths, Boolean.FALSE, new Boolean(!storeVOHasToBeStored.booleanValue()&&storeVOIsRoot),false,broker));
                            }
                        }
                    }



                    iterator = oneToNReferenceObjectCascadingStoreMap.keySet().iterator();
                    String  oneToNReferenceObjectCascadingStoreFirstAttributeName;
                    while(iterator.hasNext()){
                        oneToNReferenceObjectCascadingStoreFirstAttributeName = (String) iterator.next();
                        Collection oneToNReferenceObjectCascadingStoreFirstAttributeValue = (Collection)propertyUtilsBean.getProperty(storeVO, oneToNReferenceObjectCascadingStoreFirstAttributeName);
                        if(oneToNReferenceObjectCascadingStoreFirstAttributeValue!=null){
                            ArrayList<String>   oneToNReferenceObjectCascadingStoreSubPaths = oneToNReferenceObjectCascadingStoreMap.get(oneToNReferenceObjectCascadingStoreFirstAttributeName);
                            Iterator iterator2 = oneToNReferenceObjectCascadingStoreFirstAttributeValue.iterator();
                            while(iterator2.hasNext()){
                                valueObjectToLinkAndStoreMaps.addAll(storePathsCascade( iterator2.next(), oneToNReferenceObjectCascadingStoreSubPaths, Boolean.FALSE, new Boolean(!storeVOHasToBeStored.booleanValue()&&storeVOIsRoot),false,broker));
                            }
                        }
                    }

                    //valueObjectToLinkAndStoreMaps.add(new Object[]{storeVO,mToNReferenceNoneCascadingStoreFirstAttributeName});
                    valueObjectToLinkAndStoreMaps.add(new ValueObjectToLinkAndStoreMap(storeVO, mToNReferenceNoneCascadingStoreMap, oneToNReferenceNoneCascadingStoreMap, oneToNReferenceLinkCascadingStoreMap));

                    if(storeVOHasToBeStored.booleanValue()){
                        log.debug("storePathsCascade: storing storeVO = "+ storeVO.toString());
                        broker.store(storeVO);
                         //HashMap<String,ArrayList<String>>


                        Iterator<ValueObjectToLinkAndStoreMap> valueObjectToLinkAndStoreMapsIterator = valueObjectToLinkAndStoreMaps.iterator();
                        while(valueObjectToLinkAndStoreMapsIterator.hasNext())  {
                            ValueObjectToLinkAndStoreMap valueObjectToLinkAndStoreMap = valueObjectToLinkAndStoreMapsIterator.next();
                            HashMap<String,ArrayList<String>> toStoreMap = valueObjectToLinkAndStoreMap.getToStoreMap();
                            Iterator<String> toStoreMapKeySetIterator = toStoreMap.keySet().iterator();
                            while(toStoreMapKeySetIterator.hasNext())  {
                                String toStoreFirstAttributeName = toStoreMapKeySetIterator.next();
                                setInverseForeignKeyFields(valueObjectToLinkAndStoreMap.getValueObject(), toStoreFirstAttributeName,broker); //added by Alessandro on Nov the 8th 2008 todo syncronize design
                                Collection toStoreFirstAttributeValue = (Collection)propertyUtilsBean.getProperty(valueObjectToLinkAndStoreMap.getValueObject(), toStoreFirstAttributeName);
                                if(toStoreFirstAttributeValue!=null){
                                    ArrayList<String>   toStoreSubPaths =toStoreMap.get(toStoreFirstAttributeName);
                                    Iterator toStoreFirstAttributeValueIterator = toStoreFirstAttributeValue.iterator();
                                    while(toStoreFirstAttributeValueIterator.hasNext()){
                                        Object currentVO = toStoreFirstAttributeValueIterator.next();
                                        storePathsCascade(currentVO, toStoreSubPaths, Boolean.FALSE, Boolean.TRUE, false, broker);
                                        //brokerHelper.link(storeVO,oneToNReferenceNoneCascadingStoreFirstAttributeName,currentVO,false) ;    //deleted by Alessandro on Nov the 8th 2008 todo syncronize design
                                    }
                                }

                            }

                            HashMap<String,ArrayList<String>> toLinkMap = valueObjectToLinkAndStoreMap.getToLinkMap();
                            Iterator<String> toLinkMapMapKeySetIterator = toLinkMap.keySet().iterator();
                            BrokerHelper brokerHelper = broker.serviceBrokerHelper();
                            while(toLinkMapMapKeySetIterator.hasNext())  {
                                String toLinkFirstAttributeName = toLinkMapMapKeySetIterator.next();

                                Collection<Identity> inBeanNotStoredOrNotReferencedIdentities = getInBeanNotStoredOrNotReferencedIdentities(valueObjectToLinkAndStoreMap.getValueObject(), toLinkFirstAttributeName, broker); // sure are not referenced as nextStoreVOs as already been stored
                                if (inBeanNotStoredOrNotReferencedIdentities!=null){
                                    Iterator<Identity> inBeanNotStoredOrNotReferencedIdentitiesIterator = inBeanNotStoredOrNotReferencedIdentities.iterator();
                                    while(inBeanNotStoredOrNotReferencedIdentitiesIterator.hasNext()) {
                                        Object  reference = createObjectFromIdentity(inBeanNotStoredOrNotReferencedIdentitiesIterator.next(),broker);
                                        log.debug("storePathsCascade: linking : "+valueObjectToLinkAndStoreMap.getValueObject().toString()+" trough "+toLinkFirstAttributeName+ " with "+reference.toString());
                                        boolean succesfulLink =brokerHelper.link(valueObjectToLinkAndStoreMap.getValueObject(), toLinkFirstAttributeName, reference, false);
                                        log.debug("storePathsCascade: succesfulLink : "+succesfulLink);
                                   }
                                }
                            }

                        }
                        valueObjectToLinkAndStoreMaps.clear();
                    }


                }else{
                    if(storeVOHasToBeStored.booleanValue())broker.store(storeVO);
                }
            }

        } catch (OptimisticLockException e) {
        	log.error("OptimisticLockException thrown in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  boolean storeVOIsRoot, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  boolean storeVOIsRoot, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  boolean storeVOIsRoot, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  boolean storeVOIsRoot, PersistenceBroker broker): " + e.toString(),e);
        }  catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,  boolean storeVOIsRoot, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored,   boolean storeVOIsRoot,PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.storePathsCascade(Object storeVO, Collection<String> paths, Boolean pathsHasToBeSorted, Boolean  storeVOHasToBeStored, boolean storeVOIsRoot, PersistenceBroker broker)***************");
        return valueObjectToLinkAndStoreMaps;
    }

    /**
     *
     * @param storeVO
     * @param trees
     * @param storeVOHasToBeUpdated
     * @param deleteChangedOneToOne
     * @param applyDeletePathCascade
     * @param ifM2NDeleteOnlyRelationship
     * @param deleteOneToOne
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    public Object updateCreateTrees(Object storeVO,Collection<String> trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker)***************");

        try{
            if(storeVO != null){
                //storeVO, trees, storeVOHasToBeUpdated, Boolean.FALSE, Boolean.TRUE, Boolean.TRUE, Boolean.FALSE, broker
                if(storeVOHasToBeUpdated==null)storeVOHasToBeUpdated=Boolean.TRUE;
                if(deleteChangedOneToOne==null)deleteChangedOneToOne=Boolean.FALSE;
                if(applyDeletePathCascade==null)applyDeletePathCascade=Boolean.TRUE;
                if(ifM2NDeleteOnlyRelationship==null)ifM2NDeleteOnlyRelationship=Boolean.TRUE;
                if(deleteOneToOne==null)deleteOneToOne=Boolean.FALSE;
                if(trees==null || trees.isEmpty()){
                    if(storeVOHasToBeUpdated.booleanValue()){
                        broker.store(storeVO);
                    }
                    //return storeVO;
                }else {
                    Collection<IdentityPaths> changedDirectReferencesInPaths = null;
                    if(deleteChangedOneToOne.booleanValue()){
                        changedDirectReferencesInPaths = getChangedDirectReferencesInPaths(storeVO,trees, Boolean.TRUE, broker) ;
                        log.debug("updateCreateTrees: changedDirectReferencesInPaths.size() = "+changedDirectReferencesInPaths.size());
                    }
                    deleteItemsNotInCollectionsInPaths(storeVO,trees,Boolean.TRUE, applyDeletePathCascade, ifM2NDeleteOnlyRelationship, deleteOneToOne,broker);
                    storePathsCascade(storeVO,trees,Boolean.TRUE,storeVOHasToBeUpdated,broker);
                    if(deleteChangedOneToOne.booleanValue() && changedDirectReferencesInPaths!=null){
                        Iterator<IdentityPaths> iterator =  changedDirectReferencesInPaths.iterator();
                        if(applyDeletePathCascade.booleanValue()){
                            while (iterator.hasNext()){
                                IdentityPaths identityPaths =   iterator.next();
                                log.debug("updateCreateTrees: identity =  "+identityPaths.getIdentity().toString());
                                if(log.isDebugEnabled()) {
                                    Iterator identityPathsIterator = identityPaths.getPaths().iterator();
                                    while(identityPathsIterator.hasNext()){
                                        log.debug("updateCreateTrees: identityPathsIterator.next() =  "+identityPathsIterator.next().toString());

                                    }
                                }
                                deleteIdentityPathsCascade(identityPaths.getIdentity(), identityPaths.getPaths(), Boolean.FALSE, ifM2NDeleteOnlyRelationship,deleteOneToOne,broker);
                            }
                        } else{
                            while (iterator.hasNext()){
                                IdentityPaths identityPaths =   iterator.next();
                                deleteIdentity(identityPaths.getIdentity(),broker);
                            }
                        }
                    }
                }
            }


        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString(),e);
        }/* catch (DataOptimisticLockException e) {
            log.error("DataOptimisticLockException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, boolean updatestoreVO, PersistenceBroker broker): " + e.toString());
            throw new DataOptimisticLockException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, boolean updatestoreVO, PersistenceBroker broker): " + e.toString(),e);
        }*/ catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, Boolean deleteChangedOneToOne, Boolean applyDeletePathCascade, Boolean ifM2NDeleteOnlyRelationship, Boolean deleteOneToOne, PersistenceBroker broker) ***************");
        return storeVO;
    }

    /**
     *
     * @param storeVO
     * @param trees
     * @param storeVOHasToBeUpdated
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     * @throws org.apache.ojb.broker.OptimisticLockException
     */
    public Object updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker) ***************");

        try{
            storeVO = updateCreateTrees(storeVO, trees, storeVOHasToBeUpdated, Boolean.FALSE, Boolean.TRUE, Boolean.TRUE, Boolean.FALSE, broker);
        } catch (OptimisticLockException e) {
            log.error("OptimisticLockException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString());
            throw new OptimisticLockException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString(),e);
        } catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString(),e);
        }/* catch (DataOptimisticLockException e) {
            log.error("DataOptimisticLockException thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, boolean updatestoreVO, PersistenceBroker broker): " + e.toString());
            throw new DataOptimisticLockException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, boolean updatestoreVO, PersistenceBroker broker): " + e.toString(),e);
        }*/ catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, Boolean storeVOHasToBeUpdated, PersistenceBroker broker) ***************");
        return storeVO;
    }


    public Object updateCreateTrees(Object storeVO,Collection trees, PersistenceBroker broker) throws OjbPbCoreException, OptimisticLockException{
        log.info("************Entering the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, PersistenceBroker broker) ***************");
        Object object= updateCreateTrees( storeVO, trees,Boolean.TRUE,broker);
        log.info("************Done with the BaseOjbPbCore.updateCreateTrees(Object storeVO,Collection trees, PersistenceBroker broker) ***************");
        return object;
    }








    /**
     *
     * @param startIdentities
     * @param attributeDescriptorsForPath
     * @param startIndex
     * @param endIndex
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    private ArrayList<Identity> getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker)***************");
        ArrayList<Identity> partialPathIdentities =null;
        if (attributeDescriptorsForPath == null)  throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker):Error:attributeDescriptorsForPath can't be null " );
        if (startIdentities == null)  throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker):Error:startIdentities can't be null " );
        if (startIndex > endIndex)  throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:startIndex can't be higher than endIndex " );
        if (endIndex >= attributeDescriptorsForPath.size())  throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:endIndex must be less than attributeDescriptorsForPath size" );
        if (startIndex<0)  throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:startIndex can't be less than 0" );
        try{
            if(startIdentities.isEmpty() || attributeDescriptorsForPath.isEmpty()){
                partialPathIdentities = startIdentities;
            } else{

                /** start checking all identities of startIdentities have the same objectsRealClass**/
                Iterator<Identity> iterator =  startIdentities.iterator();
                Identity firstStartIdentity = iterator.next(); // at least one identity is in startIdentities as it is not empty.
                if(firstStartIdentity== null)     throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:startIdentities(0) is null" );
                Class realClass =   firstStartIdentity.getObjectsRealClass();
                if(realClass==null)   throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error: startIdentities(0) objectRealClass is null" );
                while (iterator.hasNext()){
                    Identity identity = iterator.next();
                    if(identity== null)     throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:found one identity in startIdentities that is  null" );
                    Class identityRealClass = identity.getObjectsRealClass();
                    if(identityRealClass==null)   throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:found one identity in startIdentities with objectRealClass null" );
                    if(!identityRealClass.equals(realClass)) throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): Error:found two identities in startIdentities with different objectRealClass" );
                }
                /** end checking all identities of startIdentities have the same objectsRealClass**/

                /******start calculate path from startIndex to endindex*********/
                String path = ((AttributeDescriptorBase)attributeDescriptorsForPath.get(startIndex)).getAttributeName();
                int index = startIndex +1;
                while (index <= endIndex){
                    path = path+"."+ ((AttributeDescriptorBase)attributeDescriptorsForPath.get(index)).getAttributeName();
                    index++;
                }
                /******start calculate path from startIndex to endindex*********/


                FieldDescriptor[] pkFields = broker.getClassDescriptor(realClass).getPkFields();
                Criteria criteria = new Criteria();
                iterator =  startIdentities.iterator();
                while (iterator.hasNext()){
                    Criteria orCriteria = new Criteria();
                    Identity startIdentity = (Identity)iterator.next();
                    Object[] pkValues = startIdentity.getPrimaryKeyValues();
                    for (int ind = 0; ind <pkValues.length; ind++){
                        orCriteria.addEqualTo(pkFields[ind].getAttributeName(),pkValues[ind]);
                    }
                    criteria.addOrCriteria(orCriteria);
                }
                ReportQueryByCriteria query = QueryFactory.newReportQuery(realClass, criteria);
                Class itemClass = ((ObjectReferenceDescriptor)attributeDescriptorsForPath.get(endIndex)).getItemClass();
                FieldDescriptor[] itemClassPkFields = broker.getClassDescriptor(itemClass).getPkFields();

                String[] attributes = new String[itemClassPkFields.length];
                String[] pkFieldNames = new String[itemClassPkFields.length];

                for (int i = 0; i< attributes.length;i++){
                    pkFieldNames[i] = itemClassPkFields[i].getAttributeName();
                    attributes[i]  = path+"."+ pkFieldNames[i];

                }

                query.setAttributes(attributes);
                Iterator reportIterator = broker.getReportQueryIteratorByQuery(query);
                IdentityFactory identityFactory= broker.serviceIdentity();

                partialPathIdentities= new ArrayList<Identity>();

                while (reportIterator.hasNext()){
                    Identity partialPathIdentity = identityFactory.buildIdentity(realClass,  pkFieldNames,(Object[]) reportIterator.next());
                    partialPathIdentity.setObjectsRealClass(itemClass);
                    partialPathIdentities.add(partialPathIdentity) ;

                }

            }
        }catch (PersistenceBrokerException e) {
            log.error("PersistenceBrokerException thrown in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): " + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the BaseOjbPbCore.getPartialPathIdentities(ArrayList<Identity> startIdentities, ArrayList attributeDescriptorsForPath, int startIndex, int endIndex, PersistenceBroker broker)***************");
        return  partialPathIdentities;
    }


    /***********************************************************************************/


    public Class getClassFromPath(Class realClass, String path, PersistenceBroker broker) throws OjbPbCoreException{
        ClassDescriptor cld;
            try{
                //if (path==null||path.trim().equals("")) return null;
                if (path==null) return null;
                if (path.trim().equals("")) return realClass;
                String[] pathArray = path.split("\\.");
                for (int i=0; i<pathArray.length;i++){
                    cld = broker.getClassDescriptor(realClass);
                    if (cld.getObjectReferenceDescriptorByName(pathArray[i])!=null){
                        realClass = cld.getObjectReferenceDescriptorByName(pathArray[i]).getItemClass();
                    }else if(cld.getCollectionDescriptorByName(pathArray[i])!=null){
                        realClass = cld.getCollectionDescriptorByName(pathArray[i]).getItemClass();
                    }else return null;
                }
            } catch (Exception e) {
                log.error("Exception thrown in  BaseOjbPbCore.getClassFromPath(Class realClass, String path, PersistenceBroker broker): " + e.toString());
                throw new OjbPbCoreException("Error in  BaseOjbPbCore.getClassFromPath(Class realClass, String path, PersistenceBroker broker): " + e.toString(),e);
            }
        return realClass;
    }

    public Class getCollectionClassFromPath(Class realClass, String path, PersistenceBroker broker) throws OjbPbCoreException{
        ClassDescriptor cld;
        try{
            if (path==null||path.trim().equals("")) return null;
            String[] pathArray = path.split("\\.");
            for (int i=0; i<pathArray.length-1;i++){
                cld = broker.getClassDescriptor(realClass);
                if (cld.getObjectReferenceDescriptorByName(pathArray[i])!=null){
                    realClass = cld.getObjectReferenceDescriptorByName(pathArray[i]).getItemClass();
                }else if(cld.getCollectionDescriptorByName(pathArray[i])!=null){
                    realClass = cld.getCollectionDescriptorByName(pathArray[i]).getItemClass();
                }else return null;
            }
            cld = broker.getClassDescriptor(realClass);
            if (cld.getCollectionDescriptorByName(pathArray[pathArray.length-1])!=null){
                realClass = cld.getCollectionDescriptorByName(pathArray[pathArray.length-1]).getCollectionClass();
                //if (realClass==null) realClass =  Vector.class;
            }else return null;
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getCollectionClassFromPath(Class realClass, String path, PersistenceBroker broker) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getCollectionClassFromPath(Class realClass, String path, PersistenceBroker broker) : " + e.toString(),e);
        }
        return realClass;
    }



    public Vector getFksToItemClassInDecomposedRelationship(Class realClass, String oneToN, String mToOne, PersistenceBroker broker) throws OjbPbCoreException{
        Vector flds;
        try{
            flds = broker.getClassDescriptor(broker.getClassDescriptor(realClass).getCollectionDescriptorByName(oneToN).getItemClass()).getObjectReferenceDescriptorByName(mToOne).getForeignKeyFields();

        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getFksToItemClassInDecomposedRelationship(Class realClass, String oneToN, String mToOne, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getFksToItemClassInDecomposedRelationship(Class realClass, String oneToN, String mToOne, PersistenceBroker broker): " + e.toString(),e);
        }
        return flds;
    }

    public Object[] getKeyValues(Object valueObject, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getKeyValues(Object valueObject, PersistenceBroker broker)  ***************");
        Object[] keyValues = null;
        try{
            BrokerHelper brokerHelper = broker.serviceBrokerHelper();

            ValueContainer[] container = brokerHelper.getKeyValues(broker.getClassDescriptor(valueObject.getClass()),valueObject);
            if (container!=null){
                keyValues = new Object[container.length];
                for(int i=0;i<container.length;i++){
                    keyValues[i]=container[i].getValue();
                }
            }
            log.debug("BaseOjbPbCore.getKeyValues(Object valueObject, PersistenceBroker broker): keyValues obtained");
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getKeyValues(Object valueObject, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getKeyValues(Object valueObject, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getKeyValues(Object valueObject, PersistenceBroker broker)**************");
        return keyValues;

    }

    /**
     * TODO add to DAO and make a test
     *
     * added by Alessandro on 1st Nov 2008 copying from ImplApplicationService
     * @param pInstance
     * @param pAttributeName
     * @param broker
     * @return
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public Object[] getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) ***************");
        Object[] keyValues = null;
        try{


            if (pInstance==null) return null; // modified by alessandro on 02/02/2008
            if (pAttributeName==null || pAttributeName.trim().equals("")) {
                //return getKeyValues(pInstance,broker);
                keyValues = getKeyValues(pInstance,broker);
            } else   {
                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                Object valueObjectToGetKeyValues=propertyUtilsBean.getProperty(pInstance,pAttributeName);
                if(valueObjectToGetKeyValues==null) return null;

                //return getKeyValues(valueObjectToGetKeyValues,broker);
                keyValues = getKeyValues(valueObjectToGetKeyValues,broker);
            }

            log.debug("BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) : keyValues obtained");
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException caught in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            log.error("InvocationTargetException caught in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException caught in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception caught in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker) " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getKeyValues(Object pInstance,String pAttributeName, PersistenceBroker broker)***************");
        return  keyValues;
    }

    public String[] getPkNames(Class realClass, PersistenceBroker broker) throws OjbPbCoreException{
        String[] pkNames;
        try{
            FieldDescriptor[] fields = broker.getClassDescriptor(realClass).getPkFields();
            pkNames=new String[fields.length];
            for (int i=0; i<pkNames.length;i++){
                pkNames[i]= fields[i].getAttributeName();
            }

        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getPkNames(Class realClass, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getPkNames(Class realClass, PersistenceBroker broker): " + e.toString(),e);
        }
        return pkNames;
    }

     public String[] getFksToThisClass(Class realClass, String oneToN, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getFksToThisClass(Class realClass, String oneToN, PersistenceBroker broker))***************");
        String[] flds;
        try{
            flds = broker.getClassDescriptor(realClass).getCollectionDescriptorByName(oneToN).getFksToThisClass();
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getFksToThisClass(Class realClass, String oneToN, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getFksToThisClass(Class realClass, String oneToN, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getFksToThisClass(Class realClass, String oneToN, PersistenceBroker broker)***************");
        return flds;
    }

    public Vector getForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker)***************");
        Vector flds = null;
        try{
            if (realClass == null ) throw new OjbPbCoreException("Error in  BaseOjbPbCore.getForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker): realClass can't be null");
            if (pAttributeName == null || pAttributeName.trim().equals("")) return null;
            String[] exceptLastTokenAndLastToken = Utils.getExceptLastTokenAndLastToken(pAttributeName);
            Class penultimateRealClass = getClassFromPath(realClass,exceptLastTokenAndLastToken[0],broker);
            flds = broker.getClassDescriptor(penultimateRealClass).getObjectReferenceDescriptorByName(exceptLastTokenAndLastToken[1]).getForeignKeyFields(); // changed by alessandro on 07/01/2008
        } catch (Exception e) {
            log.error("Exception thrown in  BaseOjbPbCore.getForeignKeyFields(Class realClass, String pAttributeName) : " + e.toString());
            throw new OjbPbCoreException("Error in  BaseOjbPbCore.getForeignKeyFields(Class realClass, String pAttributeName): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getForeignKeyFields(Class realClass, String pAttributeName)***************");
        return flds;
    }

    public Vector getInverseForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.getInverseForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker)***************");
        Vector flds ;
        try{
            log.debug("getInverseForeignKeyFields : realClass="+realClass);
            log.debug("getInverseForeignKeyFields : pAttributeName="+pAttributeName);
            // start added by alessandro on 07/01/2008
            String[] exceptLastTokenAndLastToken = Utils.getExceptLastTokenAndLastToken(pAttributeName);
            Class penultimateRealClass = getClassFromPath(realClass, exceptLastTokenAndLastToken[0], broker);
            flds = broker.getClassDescriptor(penultimateRealClass).getCollectionDescriptorByName(exceptLastTokenAndLastToken[1]).getForeignKeyFields();
            // end added by alessandro on 07/01/2008
            //flds = broker.getClassDescriptor(realClass).getCollectionDescriptorByName(collectionName).getForeignKeyFields(); deleted by alessandro on 07/01/2008
        } catch (Exception e) {
            log.error("Exception thrown in BaseOjbPbCore.getInverseForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("Error in BaseOjbPbCore.getInverseForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker): " + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.getInverseForeignKeyFields(Class realClass, String pAttributeName, PersistenceBroker broker)***************");
        return flds;
    }


    /**
     * added by alessandro on 1st Nov 2008 copying from ImplApplicationService
     *
     * @param pInstance
     * @param pAttributeName
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public void setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        log.info("************Entering the BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)***************");
        try{
            String [] exceptLastTokenAndLastToken = Utils.getExceptLastTokenAndLastToken(pAttributeName);
            Collection inverseForeignKeyFields = getInverseForeignKeyFields(pInstance.getClass(),pAttributeName,broker);
            if(inverseForeignKeyFields!=null &&!inverseForeignKeyFields.isEmpty()) { // condition added by alessandro on 28-nov-2008
                Object[] keyValues = getKeyValues(pInstance,exceptLastTokenAndLastToken[0],broker);

                log.debug("BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker) : keyValues obtained");
                if (inverseForeignKeyFields== null||inverseForeignKeyFields.isEmpty()) throw new OjbPbCoreException("OjbPbCoreException thrown in  BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker):No Foreign Key Fields found" );
                if (keyValues== null||keyValues.length==0) throw new OjbPbCoreException("OjbPbCoreException thrown in  BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker):No pInstance PKValues found" );
                if (keyValues.length!=inverseForeignKeyFields.size())  throw new OjbPbCoreException("OjbPbCoreException thrown in  BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker):Foreign Key Fields and pInstance PKValues do not have the same number of elements " );
                PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
                Collection pAttributeNameCollection =(Collection) propertyUtilsBean.getProperty(pInstance,pAttributeName);

                log.debug("BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker) : before condition on pAttributeNameCollection");

                if(pAttributeNameCollection!=null){

                    log.debug("BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker) : pAttributeNameCollection!=null");


                    Iterator pAttributeNameCollectionIterator = pAttributeNameCollection.iterator();
                    while (pAttributeNameCollectionIterator.hasNext()){
                        Object pAttributeNameCollectionElement= pAttributeNameCollectionIterator.next();
                        int i=0;
                        Iterator inverseForeignKeyFieldsIterator = inverseForeignKeyFields.iterator();
                        while(inverseForeignKeyFieldsIterator.hasNext()){
                            propertyUtilsBean.setProperty(pAttributeNameCollectionElement,(String)inverseForeignKeyFieldsIterator.next(),keyValues[i]);
                            i++;
                        }
                    }
                }
            }
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException caught in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            log.error("InvocationTargetException caught in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException caught in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception caught in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        }
        log.info("************Done with the  BaseOjbPbCore.setInverseForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)***************");
    }


    /*Added by alessandro on 3rd Nov 2008 copying from ImplApplicationService
         TODO put in DAO*/

    /**
     *
     * @param pInstance
     * @param pAttributeName
     * @param broker
     * @throws it.aco.mandragora.exception.OjbPbCoreException
     */
    public void setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker) throws OjbPbCoreException{
        try{

            if (pInstance == null) throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): pInstance can't be null ");
            if(pAttributeName.trim().equals("")) return;
            Object[] foreignKeyFieldsValues;
            foreignKeyFieldsValues = getKeyValues(pInstance,pAttributeName,broker);
            //if (foreignKeyFieldsValues ==null) foreignKeyFieldsValues = new Object [];
            //if (foreignKeyFieldsValues !=null){
            String[] foreignKeyFields = (String[]) getForeignKeyFields(pInstance.getClass(),  pAttributeName,broker).toArray(new String[]{});
            if(foreignKeyFieldsValues ==null){
                foreignKeyFieldsValues = new Object[foreignKeyFields.length];
                for (int i =0; i<foreignKeyFields.length;i++) {
                    foreignKeyFieldsValues[i]=null;
                }
            }
            String[] exceptLastTokenAndLastToken =Utils.getExceptLastTokenAndLastToken(pAttributeName);
            PropertyUtilsBean propertyUtilsBean = BeanUtilsBean.getInstance().getPropertyUtils();
            Object objectToSet;
            if (exceptLastTokenAndLastToken[0].equals("")){
                objectToSet = pInstance;
            }else{
                objectToSet = propertyUtilsBean.getProperty(pInstance,exceptLastTokenAndLastToken[0]);
            }
            BeanCollectionUtils.setAttributes(objectToSet, foreignKeyFields, foreignKeyFieldsValues);
            //}
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException caught in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeNam, PersistenceBroker brokere): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (InvocationTargetException e) {
            log.error("InvocationTargetException caught in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (NoSuchMethodException e) {
            log.error("NoSuchMethodException caught in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        } catch (Exception e) {
            log.error("Exception caught in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker): " + e.toString());
            throw new OjbPbCoreException("OjbPbCoreException thrown in BaseOjbPbCore.setForeignKeyFields(Object pInstance, String pAttributeName, PersistenceBroker broker)" + e.toString(),e);
        }
    }















}